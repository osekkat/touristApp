{"id":"bd-142","title":"Explore Feature — Browse Curated Places","description":"# Feature: Explore\n\n## Purpose\nLet users browse the curated collection of places (landmarks, museums, gardens, neighborhoods, shopping).\n\n## Why It Matters\nThis is how users discover what to see in Marrakech. The curation and presentation quality sets the tone for the entire app.\n\n## Screens\n\n### ExploreView/Screen (List)\n- Search bar at top\n- Category filter chips (All, Landmarks, Museums, Gardens, Shopping)\n- List of place cards showing:\n  - Name, category chip\n  - Short description (truncated)\n  - Open now indicator (if structured hours available)\n  - Neighborhood\n  - Expected cost range (if applicable)\n  - Saved/favorite indicator\n- Pull to refresh (updates Open Now status)\n\n### ExploreMapView (Optional)\n- Map with place markers\n- Tap marker → preview card\n- Tap preview → full detail\n- \"Near Me\" button (if location permitted)\n\n### PlaceDetailView/Screen\n- Hero image (if available)\n- Name, category, neighborhood\n- Quick fact chips: Hours, Fees, Time needed, Best time\n- Short + long description\n- \"Open now\" status (with next close/open time)\n- Local tips section\n- Scam warnings section\n- Tourist trap level indicator\n- Related items:\n  - Relevant price cards\n  - Useful phrases\n  - Related tips\n- Actions:\n  - Save/Favorite toggle\n  - Share (generates share card)\n  - Navigate (open in Maps or show offline route)\n  - Copy address\n\n## UX Requirements\n- Works 100% offline (all content from local DB)\n- Fast scrolling (lazy load images if present)\n- Filter changes are instant\n- Search is fast (<100ms)\n- Empty states for no results\n- Skeleton loading states\n\n## Data Sources\n- PlaceRepository for all place data\n- FavoritesRepository for saved state\n- RecentsRepository (record views)\n- ContentLinks for related items\n\n## Cross-Feature Integration\n- PlaceDetail is reused by Eat feature\n- Places appear in Route Cards\n- Places referenced in itineraries\n- Prices link back to places\n\n## Accessibility\n- VoiceOver/TalkBack labels for all elements\n- Proper heading hierarchy\n- Focus order makes sense\n- Touch targets ≥44pt/48dp","status":"in_progress","priority":0,"issue_type":"feature","created_at":"2026-02-07T22:32:04.584462863Z","created_by":"ubuntu","updated_at":"2026-02-08T21:37:47.160787219Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-142","depends_on_id":"bd-34f","type":"parent-child","created_at":"2026-02-07T22:32:04.587088404Z","created_by":"ubuntu"},{"issue_id":"bd-142","depends_on_id":"bd-3j8","type":"blocks","created_at":"2026-02-07T22:39:33.983318487Z","created_by":"ubuntu"}]}
{"id":"bd-169","title":"Populate Arabic script for glossary phrases","description":"Fill arabic text for existing glossary entries in shared/content/glossary.json (currently null on all records), with native-language QA for correctness and RTL rendering verification.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T23:10:57.148277819Z","created_by":"ubuntu","updated_at":"2026-02-08T21:36:58.774797153Z","closed_at":"2026-02-08T21:36:58.774754569Z","close_reason":"Completed: filled Arabic script for all glossary entries and validated shared content pipeline","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-169","depends_on_id":"bd-1s9","type":"parent-child","created_at":"2026-02-07T23:11:16.249403669Z","created_by":"ubuntu"}]}
{"id":"bd-17i","title":"Global Search — Fast Cross-Content Search","description":"# Feature: Global Search\n\n## Purpose\nFast, unified search across all content types (places, prices, phrases, tips).\n\n## Why It Matters\nUsers don't know which tab has what they need. Global search lets them find anything quickly:\n- \"hammam\" → hammam places + hammam price card + related tips\n- \"bzef\" → negotiation phrase \"too much\"\n- \"scam\" → scam awareness tips\n\n## Search UX\n\n### Entry Points\n- Search bar on Home tab\n- Search icon in navigation\n- Explore tab search\n- Phrasebook search\n\n### SearchView/Screen\n- Large search input (auto-focused)\n- Recent searches (if any)\n- Search suggestions while typing\n- Results grouped by type\n\n### Search Results Display\nSections by content type:\n1. **Places** (if matches)\n   - Place cards with name, category, neighborhood\n   - Tap → PlaceDetail\n\n2. **Prices** (if matches)\n   - Price cards with title, range\n   - Tap → PriceCardDetail\n\n3. **Phrases** (if matches)\n   - Phrase with latin + english\n   - Tap → PhraseDetail\n\n4. **Tips & Culture** (if matches)\n   - Tip title + preview\n   - Tap → TipDetail\n\n## Technical Implementation\n\n### SearchService\nprotocol SearchService {\n    func search(query: String, limit: Int) async throws -> SearchResults\n    func searchPlaces(query: String, limit: Int) async throws -> [Place]\n    func searchPriceCards(query: String, limit: Int) async throws -> [PriceCard]\n    func searchPhrases(query: String, limit: Int) async throws -> [GlossaryPhrase]\n    func searchTips(query: String, limit: Int) async throws -> [Tip]\n}\n\n### FTS Queries\nEach content type has FTS table:\n- places_fts: name, aliases, short_description, tags\n- price_cards_fts: title, category\n- phrases_fts: latin, english\n- tips_fts: title, content\n\nQuery all in parallel, aggregate results.\n\n### Normalization\nApply consistent normalization at index time and query time:\n- Lowercase\n- Diacritics removal (é → e)\n- Arabic normalization (if indexing Arabic)\n- Trim whitespace\n\n### Ranking\nSimple ranking:\n1. Exact match in name/title\n2. Alias match\n3. Prefix match\n4. Contains match\n\nBoost by content type relevance for query context.\n\n### Performance Target\n- Results appear within 100ms\n- No UI jank during search\n- Works offline\n\n## Empty State\n\"No results for [query]\"\nSuggestions:\n- Check spelling\n- Try simpler terms\n- Browse categories instead\n\n## Recent Searches\n- Store last 10 searches\n- Tap to repeat\n- Clear all option","status":"open","priority":1,"issue_type":"feature","created_at":"2026-02-07T22:34:00.787360740Z","created_by":"ubuntu","updated_at":"2026-02-07T22:39:34.129872541Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-17i","depends_on_id":"bd-34f","type":"parent-child","created_at":"2026-02-07T22:34:00.793032591Z","created_by":"ubuntu"},{"issue_id":"bd-17i","depends_on_id":"bd-3j8","type":"blocks","created_at":"2026-02-07T22:39:34.129852100Z","created_by":"ubuntu"}]}
{"id":"bd-19o","title":"Eat Feature — Curated Restaurant Guide","description":"# Feature: Eat\n\n## Purpose\nCurated restaurant and cafe recommendations with what to order, typical spend, and practical tips.\n\n## Key Difference from Explore\n- Focused specifically on food/drink venues\n- \"What to order\" recommendations\n- Dietary tags (vegetarian, family-friendly)\n- Typical spend ranges more prominent\n\n## Screens\n\n### EatView/Screen\n- Search bar\n- Filter chips: All, Budget, Rooftop, Family, Veg-Friendly\n- List of restaurant cards showing:\n  - Name\n  - Cuisine type/tags\n  - Expected cost range\n  - Open now indicator\n  - Neighborhood\n\n### PlaceDetailView (Reuse)\nSame as Explore's PlaceDetailView, but with:\n- \"What to order\" section more prominent\n- Menu highlights\n- Dietary info\n\n## Filters\n- Budget tier: $, $$, $$$\n- Location: Medina, Gueliz, Other\n- Tags: Rooftop, Family, Veg-Friendly, Tourist-Friendly, Local Favorite\n\n## Data Source\nPlaces with category = \"restaurant\" or \"cafe\"\nReuses PlaceRepository with category filter.\n\n## Integration\n- Appears in itineraries as meal stops\n- Shares PlaceDetail with Explore\n- Places can link to price cards (food/drink prices)","status":"open","priority":1,"issue_type":"feature","created_at":"2026-02-07T22:34:31.131987740Z","created_by":"ubuntu","updated_at":"2026-02-07T22:34:31.136760846Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-19o","depends_on_id":"bd-34f","type":"parent-child","created_at":"2026-02-07T22:34:31.136086086Z","created_by":"ubuntu"}]}
{"id":"bd-1av","title":"Location Services — GPS and Heading Infrastructure","description":"# Feature: Location Services\n\n## Purpose\nProvide location and heading data for Home Base compass and Route Cards while respecting battery and privacy.\n\n## Components\n\n### LocationService\nWrapper around platform location APIs:\n- iOS: CLLocationManager\n- Android: FusedLocationProviderClient\n\n### HeadingService\nWrapper around platform compass/sensor APIs:\n- iOS: CLLocationManager heading\n- Android: SensorManager with TYPE_ROTATION_VECTOR\n\n## Privacy Requirements\n- Request only \"When In Use\" / foreground location\n- Never request background location (v1)\n- Show pre-permission explanation\n- Work fully without permission (just disable location features)\n- No location sent to any server\n\n## Battery Requirements\n- Start location updates ONLY when compass screen visible\n- Stop updates when screen closes (lifecycle-aware)\n- Default to balanced accuracy, not high accuracy\n- Escalate to high accuracy only on explicit refresh\n- Automatic timeout after X minutes (prevent battery drain bugs)\n- Throttle UI updates to 10-20Hz regardless of sensor frequency\n\n## Interface\n\n### Swift (iOS)\nprotocol LocationService {\n    var currentLocation: CLLocation? { get }\n    var locationAuthorizationStatus: CLAuthorizationStatus { get }\n    func requestPermission() async -> Bool\n    func startUpdates()\n    func stopUpdates()\n    func refreshLocation() async throws -> CLLocation\n}\n\nprotocol HeadingService {\n    var currentHeading: CLHeading? { get }\n    var headingConfidence: HeadingConfidence { get }\n    func startUpdates()\n    func stopUpdates()\n}\n\nenum HeadingConfidence {\n    case good, weak, unavailable\n}\n\n### Kotlin (Android)\ninterface LocationService {\n    val currentLocation: StateFlow<Location?>\n    val permissionStatus: StateFlow<PermissionStatus>\n    suspend fun requestPermission(): Boolean\n    fun startUpdates()\n    fun stopUpdates()\n    suspend fun refreshLocation(): Location\n}\n\ninterface HeadingService {\n    val currentHeading: StateFlow<Float?>\n    val headingConfidence: StateFlow<HeadingConfidence>\n    fun startUpdates()\n    fun stopUpdates()\n}\n\n## Error Handling\n- Permission denied: Feature disabled gracefully\n- Location unavailable: Show \"Location unavailable\" message\n- Heading unreliable: Show confidence indicator, suggest recalibration\n- Timeout: Show \"couldn't get location\" with retry option\n\n## Testing\n- Test permission grant/deny flows\n- Test location updates lifecycle\n- Test heading confidence detection\n- Test battery drain during extended use","status":"open","priority":0,"issue_type":"feature","created_at":"2026-02-07T22:35:01.339401856Z","created_by":"ubuntu","updated_at":"2026-02-08T21:38:23.431970167Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-1av","depends_on_id":"bd-37x","type":"parent-child","created_at":"2026-02-07T22:35:01.349535416Z","created_by":"ubuntu"}]}
{"id":"bd-1cr","title":"Build Quote → Action UI (iOS + Android)","description":"# Task: Quote → Action UI\n\n## What to Build\nThe full UI flow for checking price fairness.\n\n## Screens\n\n### QuoteActionView/Screen (Main)\nEntry point accessible from:\n- Home screen quick action\n- Price card detail \"Check a quote\" button\n- Floating action button in Prices tab\n\n### CategoryPickerSheet\nQuick selection of price category:\n- Taxi, Hammam, Souks, Food, Guide, Other\n- Shows recent selection first\n- Can skip if coming from specific price card\n\n### PriceCardSelector\nIf multiple cards match category:\n- List of matching price cards\n- Shows expected range for each\n- Tap to select\n\n### QuoteInputView\n- Large numeric input field\n- MAD currency indicator\n- Unit label from price card (\"per ride\")\n- Quantity stepper (if applicable)\n- Clear/backspace button\n\n### ModifierToggleList\n- List of available modifiers for selected card\n- Toggle switches for each\n- Shows impact: \"+20-30%\" or similar\n- Brief explanation text\n\n### FairnessResultView\nMain results display:\n- **FairnessMeter**: Visual gauge + level text\n- **Price Comparison**:\n  - \"Expected: 40-60 MAD\"\n  - \"Adjusted: 50-75 MAD\" (if modifiers)\n  - \"Your quote: 100 MAD\"\n- **Verdict**: Clear statement\n- **Counter Suggestion**: \"Try: 50-60 MAD\"\n- **Scripts Section**: Expandable with Darija/English/French\n- **If Low**: Clarification checklist\n- **If Very High**: Walk away guidance + alternatives\n- **Save Quote**: Store for later reference\n\n### RecentQuotesSheet\n- Last 10 Quote → Action checks\n- Shows: category, amount, result, timestamp\n- Tap to re-check with current prices\n\n## FairnessMeter Component\nVisual representation of fairness:\n- Horizontal gauge with colored segments\n- Marker showing where quote falls\n- Text label: \"Fair\" / \"High\" / etc.\n- Color: green/terracotta/amber/red\n\n## Component States\n- loading: skeleton while card loads\n- input: waiting for quote amount\n- calculating: brief processing state\n- result: showing fairness assessment\n- error: if something fails (rare, all offline)\n\n## Accessibility\n- Fairness announced with context: \"Your quote of 100 MAD is very high. Expected range is 40 to 60 MAD.\"\n- Scripts readable by screen reader\n- Color not sole indicator\n\n## Platform Parity\nSame flow, same information, same order.\nVisual styling uses platform conventions.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T22:33:20.178347806Z","created_by":"ubuntu","updated_at":"2026-02-07T22:39:34.184128765Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-1cr","depends_on_id":"bd-1f7","type":"blocks","created_at":"2026-02-07T22:39:34.184109136Z","created_by":"ubuntu"},{"issue_id":"bd-1cr","depends_on_id":"bd-1pw","type":"parent-child","created_at":"2026-02-07T22:33:20.181416390Z","created_by":"ubuntu"}]}
{"id":"bd-1d5","title":"More Tab — Navigation Hub + Settings","description":"# Feature: More Tab\n\n## Purpose\nHub for secondary features: Phrasebook, Itineraries, Tips, Culture, and Settings.\n\n## Screens\n\n### MoreView/Screen\nNavigation list:\n- **Darija Phrasebook** → PhrasebookView\n- **Itineraries** → ItinerariesListView\n- **Tips & Safety** → TipsView\n- **Culture & Etiquette** → CultureView\n- **Saved Items** → FavoritesView\n- **Settings** → SettingsView\n\n### ItinerariesListView\n- List of pre-built itineraries\n- Title, duration, description preview\n- Tap for detail\n\n### ItineraryDetailView\n- Title, duration\n- Overview text\n- List of steps with:\n  - Place/activity name\n  - Time estimate\n  - Brief description\n- \"Start Route\" button → Route Cards\n- Save/favorite\n\n### TipsView\n- Categories: Scams, Safety, Practical, Arrival\n- List of tip cards\n- Tap for detail\n\n### TipDetailView\n- Title, content\n- Related places (if any)\n- Related price cards (if any)\n\n### CultureView\n- List of culture articles\n- Do's and Don'ts format\n- Tap for detail\n\n### FavoritesView\n- Grouped by content type\n- Empty state if no favorites\n- Tap item → appropriate detail view\n\n## Placement Logic\nMore tab catches everything that doesn't fit main tabs but is still valuable:\n- Phrasebook (could be its own tab but 5-tab limit)\n- Itineraries (discovery, not daily use)\n- Tips/Culture (reference, not daily use)\n- Settings (standard placement)\n\n## Accessibility\n- Standard list accessibility\n- Proper heading hierarchy\n- All items reachable via keyboard/switch control","status":"open","priority":1,"issue_type":"feature","created_at":"2026-02-07T22:34:44.628379629Z","created_by":"ubuntu","updated_at":"2026-02-07T22:49:22.595741079Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-1d5","depends_on_id":"bd-34f","type":"parent-child","created_at":"2026-02-07T22:34:44.631092240Z","created_by":"ubuntu"}]}
{"id":"bd-1eo","title":"Phase 3: Polish & Store Readiness — Paid App Quality","description":"# Epic: Polish & Store Readiness\n\n## Purpose\nTransform the functional app into a polished, premium experience worthy of the paid price point. This phase handles onboarding, downloads, accessibility, localization, visual polish, and store submission.\n\n## Why This Phase Matters\nA paid app must feel polished from the first second. Users who paid $5-10 expect:\n- Clear onboarding that builds trust\n- Beautiful, consistent visual design\n- Accessibility for all users\n- Reliable offline behavior with clear messaging\n- No dead-ends, broken states, or janky UI\n\nThis phase is what separates \"it works\" from \"I'm glad I bought this.\"\n\n## What Gets Built\n\n### 1. Onboarding Flow\nFirst-run experience (60-90 seconds, skippable, re-runnable from Settings):\n1. Language + home currency picker\n2. Offline promise screen (what works offline vs online)\n3. Downloads picker (optional packs with sizes)\n4. Offline Readiness Check (validation + \"Test in Airplane Mode\")\n5. Quick demo: Quote → Action with taxi example\n6. Privacy + Permissions explainer (no accounts, no ads, no data selling)\n\n### 2. Settings & Diagnostics\n- SettingsView with all user preferences\n- DownloadsView (pack manager with progress, pause/resume/cancel)\n- DiagnosticsView (content version, sync status, storage usage, offline readiness)\n- Privacy Center (plain-language data explanation)\n- Exchange rate manual entry\n- Wi-Fi only download toggle\n\n### 3. Downloads System\nTreat downloads as a product surface:\n- DownloadService with background capability\n- Pack manifest handling with dependencies\n- Progress tracking (determinate, not spinner)\n- Pause/resume/cancel with state persistence\n- Verification (sha256) before installation\n- Atomic install with rollback support\n- Clear error messages with recovery actions\n\n### 4. Offline UX Polish\nEvery screen follows the standard state model:\n- loading → skeleton/placeholder (never blank)\n- content → normal display\n- refreshing → subtle progress over content\n- offline → cached content + clear messaging\n- error → explanation + next action (Retry/Downloads/Work offline)\n\n### 5. Accessibility\nBoth platforms must pass accessibility audits:\n- VoiceOver (iOS) / TalkBack (Android) on core flows\n- Dynamic type / font scaling\n- Touch targets (iOS ≥44pt, Android ≥48dp)\n- Correct focus order\n- Sufficient contrast ratios\n- RTL readiness for Arabic text\n\n### 6. Localization\n- EN strings for both platforms\n- FR strings for both platforms (UI only, content stays EN for v1)\n- Locale-aware date/number/currency formatting\n- Safe fallback to EN if translation missing\n\n### 7. Visual Design Polish\nImplement the Marrakech visual identity:\n- Terracotta color palette (warm clay/earth tones)\n- Islamic geometric patterns (subtle, not distracting)\n- Consistent design tokens across platforms\n- Dark mode with warm identity (not generic blue/purple)\n- Share card design for screenshots/social\n\n### 8. Store Readiness\n- App Store screenshots (showing offline, pricing, navigation)\n- Play Store screenshots\n- Store descriptions emphasizing value\n- What's new content from content changelog\n- App Store video (optional but valuable)\n\n## Quality Gates\nBefore store submission:\n- Offline smoke test passes (airplane mode immediately after install)\n- Accessibility audit passes\n- All localized strings present\n- Dark mode verified\n- Performance budgets met (cold start <2s, search <100ms)\n- No forbidden permissions (contacts, photos)\n\n## Technical Components\n\n### Views/Screens\n- OnboardingFlow (multi-step)\n- SettingsView, DownloadsView, DiagnosticsView\n- Privacy Center\n\n### Services\n- DownloadService (iOS: URLSession background, Android: OkHttp + WorkManager)\n- ContentSyncService (manifest check, atomic swap)\n\n### Components\n- SkeletonView, OfflineBanner, ErrorState\n- ProgressIndicator (determinate)\n\n## Success Criteria\n- First-time user understands value within 60 seconds\n- App works beautifully in airplane mode\n- Downloads are reliable and resumable\n- Accessibility users can complete core flows\n- Visual design feels premium and culturally appropriate\n- Store pages clearly communicate the value\n\n## Dependencies\n- Requires: Phase 0 Foundation\n- Requires: Phase 1 Core Features (what we're polishing)\n- Requires: Phase 2 Location Features (for complete experience)\n- Blocks: Store submission","status":"open","priority":1,"issue_type":"epic","created_at":"2026-02-07T22:24:14.221524009Z","created_by":"ubuntu","updated_at":"2026-02-07T22:39:27.148754096Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-1eo","depends_on_id":"bd-37x","type":"blocks","created_at":"2026-02-07T22:39:27.148736570Z","created_by":"ubuntu"}]}
{"id":"bd-1f7","title":"Implement PricingEngine with shared test vectors","description":"# Task: PricingEngine Implementation\n\n## What to Build\nThe deterministic calculation engine that powers Quote → Action.\n\n## Critical Requirement\niOS and Android implementations MUST produce identical outputs for identical inputs.\n\n## Interface\n\n### Swift (iOS)\nstruct PricingEngineInput {\n    let priceCard: PriceCard\n    let quotedMAD: Int\n    let selectedModifiers: [ContextModifier]\n    let quantity: Int\n}\n\nstruct PricingEngineOutput {\n    let adjustedRange: PriceRange\n    let fairnessLevel: FairnessLevel\n    let suggestedCounterRange: PriceRange\n    let scripts: [NegotiationScript]\n    let explanation: String\n    let confidence: Confidence\n}\n\nenum FairnessLevel: String {\n    case low, fair, high, veryHigh\n}\n\nfunc evaluate(input: PricingEngineInput) -> PricingEngineOutput\n\n### Kotlin (Android)\ndata class PricingEngineInput(\n    val priceCard: PriceCard,\n    val quotedMAD: Int,\n    val selectedModifiers: List<ContextModifier>,\n    val quantity: Int = 1\n)\n\ndata class PricingEngineOutput(\n    val adjustedRange: PriceRange,\n    val fairnessLevel: FairnessLevel,\n    val suggestedCounterRange: PriceRange,\n    val scripts: List<NegotiationScript>,\n    val explanation: String,\n    val confidence: Confidence\n)\n\nfun evaluate(input: PricingEngineInput): PricingEngineOutput\n\n## Algorithm\n\n1. **Base Range**\n   minMad = priceCard.expectedCostMinMad\n   maxMad = priceCard.expectedCostMaxMad\n\n2. **Apply Modifiers**\n   for each modifier in selectedModifiers:\n     if modifier.factorMin != null:\n       minMad = minMad * modifier.factorMin\n       maxMad = maxMad * modifier.factorMax\n     if modifier.addMin != null:\n       minMad = minMad + modifier.addMin\n       maxMad = maxMad + modifier.addMax\n\n3. **Apply Quantity**\n   adjustedMin = minMad * quantity\n   adjustedMax = maxMad * quantity\n\n4. **Determine Fairness**\n   lowMultiplier = priceCard.lowMultiplier ?? 0.75\n   highMultiplier = priceCard.fairnessHighMultiplier ?? 1.25\n\n   if quotedMAD < adjustedMin * lowMultiplier:\n     fairness = .low\n   else if quotedMAD <= adjustedMax:\n     fairness = .fair\n   else if quotedMAD <= adjustedMax * highMultiplier:\n     fairness = .high\n   else:\n     fairness = .veryHigh\n\n5. **Suggested Counter**\n   counterMin = adjustedMin\n   counterMax = adjustedMax * 0.95\n\n6. **Build Explanation**\n   Human-readable explanation of the calculation.\n\n## Shared Test Vectors\n\nCreate shared/tests/pricing-engine-vectors.json:\n\n[\n  {\n    \"name\": \"Basic taxi - fair price\",\n    \"input\": {\n      \"cardId\": \"taxi-short\",\n      \"expectedMin\": 20,\n      \"expectedMax\": 40,\n      \"quotedMAD\": 30,\n      \"modifiers\": [],\n      \"quantity\": 1\n    },\n    \"expected\": {\n      \"fairness\": \"fair\",\n      \"adjustedMin\": 20,\n      \"adjustedMax\": 40,\n      \"counterMin\": 20,\n      \"counterMax\": 38\n    }\n  },\n  {\n    \"name\": \"Taxi with night modifier\",\n    \"input\": {\n      \"cardId\": \"taxi-short\",\n      \"expectedMin\": 20,\n      \"expectedMax\": 40,\n      \"quotedMAD\": 60,\n      \"modifiers\": [{ \"factorMin\": 1.2, \"factorMax\": 1.3 }],\n      \"quantity\": 1\n    },\n    \"expected\": {\n      \"fairness\": \"high\",\n      \"adjustedMin\": 24,\n      \"adjustedMax\": 52\n    }\n  },\n  {\n    \"name\": \"Very high quote\",\n    \"input\": {\n      \"cardId\": \"taxi-short\",\n      \"expectedMin\": 20,\n      \"expectedMax\": 40,\n      \"quotedMAD\": 100,\n      \"highMultiplier\": 1.25,\n      \"modifiers\": [],\n      \"quantity\": 1\n    },\n    \"expected\": {\n      \"fairness\": \"veryHigh\"\n    }\n  }\n]\n\n## Testing\nBoth iOS and Android test suites:\n1. Load shared test vectors\n2. Run PricingEngine.evaluate() on each\n3. Assert outputs match expected values\n\n## Verification\n- Unit tests pass on iOS\n- Unit tests pass on Android\n- Cross-platform consistency verified","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-07T22:32:56.919651507Z","created_by":"ubuntu","updated_at":"2026-02-08T21:37:08.317891025Z","closed_at":"2026-02-08T21:37:08.317850745Z","close_reason":"PricingEngine complete: iOS and Android implementations match, shared test vectors in place, tests on both platforms.","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-1f7","depends_on_id":"bd-1pw","type":"parent-child","created_at":"2026-02-07T22:32:56.925114965Z","created_by":"ubuntu"}]}
{"id":"bd-1f8","title":"Home Base Compass — Offline 'Get Me Back' Navigation","description":"# Feature: Home Base Compass\n\n## Purpose\nOne-tap access to \"get me back to my hotel\" using compass direction and distance. Works fully offline.\n\n## Why This Matters\nGetting lost in the Medina is a real fear for tourists. Home Base provides:\n- Confidence: \"I can always find my way back\"\n- Practical navigation: compass arrow + distance\n- Fallback: taxi driver card with address\n\n## User Flow\n\n### 1. Setup (Once)\nHome screen prompts to set Home Base on first use.\nSettings → Set Home Base also available.\n\n#### HomeBaseSetupView/Screen\n- \"Where are you staying?\" prompt\n- Options:\n  a. Use current location (needs permission)\n  b. Search for a place\n  c. Enter address manually\n  d. Drop pin on map\n- Name field: \"My Riad\" / hotel name\n- Notes field: \"Room 12\" (optional)\n- Save button\n\n### 2. Go Home (Repeated Use)\nBig \"Go Home\" button on Home screen.\n\n#### GoHomeView/Screen\n- **Compass Arrow**: Large arrow pointing toward Home Base\n  - Rotates based on heading vs bearing\n  - Animated smoothly\n- **Distance Display**: \"750 m\" or \"1.2 km\"\n- **Home Base Name**: \"Riad Dar Maya\"\n- **Last Updated**: \"Location updated 10s ago\"\n- **Heading Confidence**: \"Good\" / \"Weak\" indicator\n- **Actions**:\n  - \"Refresh Location\" button\n  - \"Show to Taxi Driver\" → Taxi Card\n  - \"Navigate\" → Open in Maps (if online)\n\n#### TaxiDriverCardView\nFull-screen display optimized for showing to taxi driver:\n- Hotel/riad name in Arabic (large, RTL)\n- Name in Latin (below)\n- Address if available\n- Simple \"Take me here\" phrase in Darija\n- High contrast, screen stays awake\n- Easy dismiss gesture\n\n### Compass Arrow Behavior\n- Points toward Home Base bearing\n- Adjusts for device heading\n- Rotation: relativeAngle(bearing, heading)\n- Smooth animation (10-20Hz updates)\n- Shows \"?\" when heading unavailable\n\n### Distance Updates\n- Updates when location changes significantly\n- Shows formatted distance (GeoEngine.formatDistance)\n- Estimated walk time below\n\n## Edge Cases\n\n### No Permission\n- Show explanation why location helps\n- \"Set Home Base\" still works with manual entry\n- \"Go Home\" shows distance but no compass (or last known)\n\n### Weak Heading\n- Show \"Heading unreliable\" message\n- Suggest: \"Keep phone flat\" / \"Walk a few steps\"\n- Arrow shows last good heading with indicator\n\n### Indoor/GPS Weak\n- Show \"GPS weak\" indicator\n- Suggest: \"Step outside for better signal\"\n- Keep showing last good position\n\n## Data Model\nHomeBase stored in UserSettings:\n{\n  \"name\": \"Riad Dar Maya\",\n  \"lat\": 31.6295,\n  \"lng\": -7.9912,\n  \"address\": \"12 Derb Sidi Bouloukate\",\n  \"notes\": \"Blue door, ask for Hassan\"\n}\n\n## Offline Guarantee\n100% offline. Uses only:\n- Stored Home Base coordinates\n- Live GPS position\n- Device compass heading\n- GeoEngine calculations\n\nNo network required ever.\n\n## Accessibility\n- Compass direction announced: \"Home Base is 750 meters to the northeast\"\n- Large touch targets\n- Screen reader skips decorative elements","status":"open","priority":0,"issue_type":"feature","created_at":"2026-02-07T22:35:46.543955944Z","created_by":"ubuntu","updated_at":"2026-02-07T22:39:41.905723931Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-1f8","depends_on_id":"bd-1av","type":"blocks","created_at":"2026-02-07T22:39:41.855204270Z","created_by":"ubuntu"},{"issue_id":"bd-1f8","depends_on_id":"bd-1iv","type":"blocks","created_at":"2026-02-07T22:39:41.905707907Z","created_by":"ubuntu"},{"issue_id":"bd-1f8","depends_on_id":"bd-37x","type":"parent-child","created_at":"2026-02-07T22:35:46.548058064Z","created_by":"ubuntu"}]}
{"id":"bd-1iv","title":"Implement GeoEngine with shared test vectors","description":"# Task: GeoEngine Implementation\n\n## What to Build\nPure utility functions for geographic calculations, used by Home Base and Route Cards.\n\n## Critical Requirement\niOS and Android implementations MUST produce identical outputs for identical inputs.\n\n## Functions\n\n### haversine(point1, point2) → meters\nCalculate great-circle distance between two coordinates.\n\nFormula:\na = sin²(Δφ/2) + cos φ1 · cos φ2 · sin²(Δλ/2)\nc = 2 · atan2(√a, √(1−a))\nd = R · c\n\nWhere R = 6371000 meters (Earth radius)\n\n### bearing(from, to) → degrees\nCalculate initial bearing from point1 to point2.\n\nFormula:\nθ = atan2(sin Δλ · cos φ2, cos φ1 · sin φ2 − sin φ1 · cos φ2 · cos Δλ)\n\nReturns 0-360 degrees (0 = North, 90 = East, etc.)\n\n### relativeAngle(bearing, heading) → degrees\nCalculate the rotation for the compass arrow.\n\nFormula:\nangle = (bearing - heading) % 360\nif angle < 0: angle += 360\n\nReturns 0-360 degrees for arrow rotation.\n\n### formatDistance(meters) → string\nHuman-readable distance:\n- Under 100m: \"X m\"\n- 100-999m: round to 10m, \"X m\"\n- 1km+: \"X.X km\"\n\n### estimateWalkTime(meters, region) → minutes\nEstimate walking time:\n- Default: 4.5 km/h (13.3 m/min)\n- Medina multiplier: 0.7 (slower, denser paths)\n- Add buffer for navigation time\n\n## Shared Test Vectors\n\nCreate shared/tests/geo-engine-vectors.json:\n\n[\n  {\n    \"name\": \"Jemaa el-Fna to Bahia Palace\",\n    \"input\": {\n      \"from\": { \"lat\": 31.6258, \"lng\": -7.9891 },\n      \"to\": { \"lat\": 31.6219, \"lng\": -7.9833 }\n    },\n    \"expected\": {\n      \"distanceMeters\": 750,\n      \"bearingDegrees\": 127,\n      \"tolerance\": 10\n    }\n  },\n  {\n    \"name\": \"Bearing North\",\n    \"input\": {\n      \"from\": { \"lat\": 31.0, \"lng\": -8.0 },\n      \"to\": { \"lat\": 32.0, \"lng\": -8.0 }\n    },\n    \"expected\": {\n      \"bearingDegrees\": 0,\n      \"tolerance\": 1\n    }\n  },\n  {\n    \"name\": \"Relative angle calculation\",\n    \"input\": {\n      \"bearing\": 90,\n      \"heading\": 45\n    },\n    \"expected\": {\n      \"relativeAngle\": 45\n    }\n  }\n]\n\n## Implementation Notes\n- Use Double precision for all calculations\n- Handle edge cases (same point, poles, date line)\n- Use standard math libraries, no custom trig\n\n## Testing\nBoth platforms load shared vectors and verify:\n- Distance within tolerance\n- Bearing within tolerance\n- Relative angle exact match","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T22:35:20.440109856Z","created_by":"ubuntu","updated_at":"2026-02-07T23:34:43.124213571Z","closed_at":"2026-02-07T23:34:43.123979591Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-1iv","depends_on_id":"bd-37x","type":"parent-child","created_at":"2026-02-07T22:35:20.444279868Z","created_by":"ubuntu"}]}
{"id":"bd-1jg","title":"Build reusable SwiftUI components (Card, Chip, PriceTag, etc.)","description":"# Task: iOS Reusable Components\n\n## What to Build\nShared SwiftUI components used across multiple features.\n\n## Components to Create\n\n### Card.swift\nContainer with shadow, rounded corners, and optional header.\n- Used for: Place cards, Price cards, Tip cards\n- Properties: title, subtitle, content slot\n\n### Chip.swift\nSmall tag/label for categories, status, filters.\n- Used for: Category filters, \"Open now\", tags\n- Variants: filled, outlined\n- Colors: theme colors + semantic\n\n### PriceTag.swift\nFormatted price display with currency.\n- Shows: \"150-200 MAD\" or \"~175 MAD\"\n- Used for: Price cards, place costs\n\n### SectionHeader.swift\nConsistent section headers with optional action.\n- Title + optional \"See all\" button\n- Used in: Home, Explore lists\n\n### OfflineBanner.swift\nBanner showing offline status.\n- Calm messaging: \"Offline • Core guide still works\"\n- Dismissible\n\n### SearchBar.swift\nConsistent search input.\n- Placeholder text\n- Clear button\n- Keyboard handling\n\n### ShareCardRenderer.swift\nGenerates share images for social.\n- Takes content data\n- Renders screenshot-friendly card\n- Uses ImageRenderer\n\n### SkeletonView.swift\nLoading placeholder for content.\n- Matches content shape\n- Animated shimmer effect\n\n### EmptyState.swift\nEmpty state with icon, message, action.\n- Used when: no favorites, no search results\n- Variants based on context\n\n### ErrorState.swift\nError display with retry action.\n- Clear error message\n- What to do next\n- Retry button\n\n## Design Principles\n- All components use theme tokens\n- Touch targets ≥44×44 pt\n- Dynamic Type support\n- VoiceOver accessibility labels\n- RTL layout support\n\n## Usage Pattern\nComponents should be composable:\nCard {\n    VStack {\n        HStack {\n            Text(place.name)\n            Chip(text: place.category, style: .filled)\n        }\n        PriceTag(min: place.feesMin, max: place.feesMax)\n    }\n}\n\n## Verification\n- Components render in previews\n- Theme colors apply\n- Accessibility labels work\n- Components compose correctly","status":"in_progress","priority":2,"issue_type":"task","created_at":"2026-02-07T22:28:07.420240385Z","created_by":"ubuntu","updated_at":"2026-02-08T21:37:56.025081363Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-1jg","depends_on_id":"bd-4aw","type":"parent-child","created_at":"2026-02-07T22:28:07.422471746Z","created_by":"ubuntu"}]}
{"id":"bd-1jv","title":"Set up Xcode project with correct structure","description":"# Task: iOS Xcode Project Setup\n\n## What to Build\nCreate the Xcode project with proper folder structure and configuration.\n\n## Project Configuration\n- Project name: MarrakechGuide\n- Bundle ID: com.marrakechguide.app (or similar)\n- Minimum deployment: iOS 16.0\n- Swift version: 5.9+\n- SwiftUI lifecycle\n\n## Folder Structure\nMarrakechGuide/\n├── App/\n│   ├── MarrakechGuideApp.swift    # @main entry point\n│   └── ContentView.swift           # Root view with TabView\n├── Core/\n│   ├── Database/\n│   ├── Repositories/\n│   ├── Services/\n│   └── Engines/\n├── Features/\n│   ├── Home/\n│   ├── Explore/\n│   ├── Eat/\n│   ├── Prices/\n│   ├── QuoteAction/\n│   ├── HomeBase/\n│   ├── MyDay/\n│   ├── RouteCards/\n│   ├── Phrasebook/\n│   ├── Search/\n│   ├── More/\n│   └── Settings/\n├── Shared/\n│   ├── Components/\n│   ├── Models/\n│   ├── Extensions/\n│   └── Utilities/\n├── Resources/\n│   ├── Assets.xcassets\n│   ├── Localizable.xcstrings\n│   ├── SeedData/\n│   │   └── content.db\n│   └── Audio/\n└── DI/\n    └── Container.swift\n\n## Package Dependencies\nAdd via Swift Package Manager:\n- GRDB.swift (https://github.com/groue/GRDB.swift)\n  - For SQLite access with FTS5 support\n\n## Build Settings\n- Enable strict concurrency checking\n- Enable implicit actor context inference\n- Warning as errors for shipping builds\n\n## Test Targets\n- MarrakechGuideTests (unit tests)\n- MarrakechGuideUITests (UI tests)\n\n## Verification\n- Project opens in Xcode without errors\n- Builds for iOS 16+ simulator\n- Runs and shows empty TabView","status":"in_progress","priority":1,"issue_type":"task","created_at":"2026-02-07T22:26:57.096257500Z","created_by":"ubuntu","updated_at":"2026-02-07T22:58:42.679818317Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-1jv","depends_on_id":"bd-4aw","type":"parent-child","created_at":"2026-02-07T22:26:57.098844575Z","created_by":"ubuntu"}]}
{"id":"bd-1ls","title":"My Day Planner — Offline Daily Plan Generation","description":"# Feature: My Day Planner\n\n## Purpose\nGenerate a realistic, personalized day plan based on user constraints. Answers \"What should I do today?\" without requiring planning effort.\n\n## Why This Matters\nFirst-time tourists face decision paralysis:\n- Too many options\n- Don't know what's realistic\n- Fear of missing something great\n- Don't know how long things take\n\nMy Day provides:\n- Curated selection based on interests\n- Realistic timing (respects travel time, opening hours)\n- Budget-appropriate choices\n- Geographically coherent routes\n\n## User Flow\n\n### 1. Constraint Picker (MyDayView)\n\n#### Time Available\nSlider: 2-10 hours\nCommon presets: \"Half day (4h)\", \"Full day (8h)\"\n\n#### Pace\n- Relaxed: fewer stops, more time each\n- Standard: balanced\n- Active: more stops, quicker pace\n\n#### Budget Tier\n- Budget: free/low-cost focus\n- Mid-range: mix\n- Splurge: premium experiences\n\n#### Interests (Multi-select)\n- History & Culture\n- Shopping & Souks\n- Food & Cafes\n- Gardens & Outdoors\n- Photography\n- Family-Friendly\n- Hammam & Wellness\n\n#### Starting Point\n- Home Base (if set)\n- Current location (if permitted)\n- Select neighborhood\n\n### 2. Plan Generation\nPress \"Build My Day\" → PlanEngine generates plan\n\n### 3. Plan Display (PlanResultView)\n- Overview: X stops, Y hours, estimated cost range\n- Timeline of stops:\n  - 9:00 - Bahia Palace (1.5h)\n  - 10:45 - Walk through souks (45min)\n  - 11:30 - Cafe Clock lunch (1h)\n  - ...\n- Each stop shows:\n  - Name and type\n  - Time estimate\n  - Why included (matches your interests)\n- Total estimated cost\n\n### 4. Actions\n- \"Start Route\" → Route Cards with this plan\n- \"Swap Stop\" → replace one item\n- \"Save Plan\" → store for later\n- \"Share\" → generate shareable image\n\n## PlanEngine Logic\n\n### Inputs\n{\n  availableMinutes: 480,\n  startPoint: { lat, lng },\n  interests: [\"history\", \"food\"],\n  pace: \"standard\",\n  budgetTier: \"mid\"\n}\n\n### Algorithm\n1. Filter places by:\n   - Matches at least one interest\n   - Fits budget tier\n   - Currently open (or will be open when we'd arrive)\n\n2. Score places by:\n   - Interest match count\n   - Tourist trap level (prefer \"local pick\")\n   - User hasn't seen recently\n\n3. Select initial set respecting time budget:\n   - Include meal stop(s) if time spans meal times\n   - Include variety (not all museums)\n\n4. Optimize route order:\n   - Geographic clustering (minimize travel time)\n   - Respect best_time_windows\n   - Respect opening hours\n\n5. Calculate timing:\n   - Walk time between stops (GeoEngine.estimateWalkTime)\n   - Visit duration (visitMinMinutes to visitMaxMinutes based on pace)\n\n### Outputs\n{\n  stops: [\n    { placeId, arrivalTime, departureTime, walkTimeFromPrevious },\n    ...\n  ],\n  totalMinutes: 420,\n  estimatedCostRange: { min: 200, max: 400 }\n}\n\n## Offline Guarantee\n100% offline. Uses only local content.db and current location (optional).\n\n## Plan Storage\nSave generated plans to user.db for later reference:\n{\n  id: \"plan-20260215-1\",\n  createdAt: \"2026-02-15T09:00:00\",\n  inputs: { ... },\n  stops: [ ... ]\n}\n\n## Platform Parity\nPlanEngine should produce similar (not necessarily identical) plans on both platforms. Randomness is acceptable but weighted by same criteria.","status":"open","priority":1,"issue_type":"feature","created_at":"2026-02-07T22:36:14.370831178Z","created_by":"ubuntu","updated_at":"2026-02-07T22:39:42.087293458Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-1ls","depends_on_id":"bd-20q","type":"blocks","created_at":"2026-02-07T22:39:42.087269703Z","created_by":"ubuntu"},{"issue_id":"bd-1ls","depends_on_id":"bd-37x","type":"parent-child","created_at":"2026-02-07T22:36:14.373773824Z","created_by":"ubuntu"}]}
{"id":"bd-1mn","title":"Prices Feature — Price Cards and Negotiation Info","description":"# Feature: Prices\n\n## Purpose\nDisplay price cards with expected costs, negotiation scripts, and red flags for common tourist spend categories.\n\n## Screens\n\n### PricesView/Screen (Category List)\n- Category sections:\n  - Taxi & Transport\n  - Hammam & Spa\n  - Souks & Shopping\n  - Food & Drink\n  - Guides & Tours\n  - Services\n- Each category shows card count\n- Quick access to Quote → Action\n\n### PriceCardListView\n- List of cards in category\n- Each shows: title, expected range, unit\n- Last reviewed date\n- Tap for detail\n\n### PriceCardDetailView/Screen\n- Title and category\n- **Expected Cost Range**: \"40-60 MAD per ride\"\n- **Last Reviewed**: \"2026-01-15\"\n- **Confidence**: High/Medium/Low indicator\n- **Volatility**: Low/Medium/High (how much prices vary)\n- **What Influences Price**: List of factors\n- **Negotiation Scripts**:\n  - Darija (Latin + Arabic)\n  - English\n  - French (if applicable)\n- **Red Flags**: Things to watch out for\n- **Context Modifiers**: Listed with impact\n- **Actions**:\n  - \"Check a Quote\" → Quote → Action with this card\n  - Save/Favorite\n  - Share\n\n## Trust UI\nEvery price card shows:\n- \"Last reviewed: [date]\"\n- Staleness warning if old (>6 months)\n- Provenance note (\"Based on recent quotes\")\n- Confidence level\n\n## Data Display\n\n### Price Range Formatting\n- \"40-60 MAD\" (when range)\n- \"~50 MAD\" (when narrow range)\n- \"150+ MAD\" (when open-ended)\n- Always show unit: \"per ride\", \"per person\", \"per kg\"\n\n### Modifiers Display\nEach modifier shows:\n- Label: \"Night (after 8pm)\"\n- Impact: \"+20-30%\"\n- Brief note\n\n### Scripts Formatting\nCollapsible sections:\n- Darija (Latin)\n- Arabic script (RTL)\n- English translation\n- French (if present)\n\n## Integration Points\n- Quote → Action uses price card data\n- Places link to relevant price cards\n- Tips reference price cards\n\n## Offline\n100% offline. All data from content.db.","status":"open","priority":1,"issue_type":"feature","created_at":"2026-02-07T22:34:18.715015672Z","created_by":"ubuntu","updated_at":"2026-02-07T22:34:18.719973715Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-1mn","depends_on_id":"bd-34f","type":"parent-child","created_at":"2026-02-07T22:34:18.719900646Z","created_by":"ubuntu"}]}
{"id":"bd-1ps","title":"Onboarding Flow — First-Run Trust Builder","description":"# Feature: Onboarding Flow\n\n## Purpose\nBuild user trust and prepare them for offline use within 60-90 seconds. Make the first experience excellent.\n\n## Why This Matters\nFirst impressions determine:\n- Whether users trust the app\n- Whether they understand the offline value\n- Whether they set up correctly for their trip\n- Whether they'll recommend to others\n\n## Flow (5 Steps)\n\n### Step 1: Welcome + Language/Currency\n- \"Welcome to your Marrakech guide\"\n- Language: English, French\n- Home currency: USD, EUR, GBP, etc.\n- \"Used for price comparisons, stored locally\"\n\n### Step 2: Offline Promise\n- \"Works without internet\"\n- What works offline: Everything essential\n- What needs internet: Optional updates, weather\n- Visual: phone with airplane mode icon\n- Builds trust immediately\n\n### Step 3: Downloads Picker\n- \"Get ready for offline\"\n- Recommended: Base Pack (included)\n- Optional: Medina Map Pack, Audio Pack\n- Shows sizes, Wi-Fi indicator\n- \"Download Later\" option (never blocks)\n- Respects Wi-Fi only setting\n\n### Step 4: Offline Readiness Check\n- Quick validation that core features work\n- \"✓ Places loaded: 47\"\n- \"✓ Price cards loaded: 23\"\n- \"✓ Search ready\"\n- \"Test in Airplane Mode\" suggestion\n- If issues: clear path to fix\n\n### Step 5: Quick Demo\n- Show Quote → Action with taxi example\n- \"You'll be quoted prices — let's practice\"\n- Walk through one check\n- \"80 MAD for a taxi ride\" → shows Fair result\n- Immediate \"aha\" moment\n\n### Step 6 (Optional): Set Home Base\n- \"Where are you staying?\"\n- Quick setup or \"Later\"\n- Not required to proceed\n\n### Final: Privacy Summary\n- \"No accounts. No ads. No data selling.\"\n- Location: only when you ask, only on-device\n- Crash reports: opt-in (if we add them)\n- \"Learn more\" → Privacy Center\n\n## Technical Implementation\n\n### OnboardingState\nenum OnboardingStep {\n    case welcome\n    case offlinePromise\n    case downloads\n    case readinessCheck\n    case demo\n    case privacy\n    case complete\n}\n\n### Persistence\n- Store onboarding completion in UserDefaults/DataStore\n- Allow re-running from Settings\n- Track current step for resume\n\n### Skip Behavior\n- User can skip to end at any time\n- But gets gentle reminder about downloads later\n- Never force anything\n\n## Re-running\nSettings → \"Run Setup Again\"\nShows same flow but remembers preferences.\n\n## Accessibility\n- VoiceOver/TalkBack friendly\n- Can navigate all steps\n- Demo is accessible\n- No time pressure","status":"open","priority":0,"issue_type":"feature","created_at":"2026-02-07T22:37:04.601880128Z","created_by":"ubuntu","updated_at":"2026-02-07T22:37:04.605005757Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-1ps","depends_on_id":"bd-1eo","type":"parent-child","created_at":"2026-02-07T22:37:04.604971526Z","created_by":"ubuntu"}]}
{"id":"bd-1pw","title":"Quote → Action Feature — The Killer Differentiator","description":"# Feature: Quote → Action\n\n## Purpose\nInstant price fairness check for the exact moment a tourist is quoted a price. This is the feature that justifies the app purchase and creates word-of-mouth.\n\n## Why This is Critical\nTourists face price negotiations multiple times per day in Marrakech. Without confidence:\n- They overpay (frustrating, erodes trust in the city)\n- They walk away from fair deals (miss experiences)\n- They feel anxious during negotiations\n\nQuote → Action provides:\n- Instant validation (\"Is 80 MAD fair for this taxi?\")\n- Counter-offer suggestions (\"Try offering 50-60 MAD\")\n- Scripts to say in Darija (\"Bzef! Khamseen?\")\n- Red flags to watch for\n\n## User Flow\n\n### 1. Entry (1 tap from Home)\nBig \"Check a Price\" button on Home screen.\nCan also access from any price card detail.\n\n### 2. Category Selection\nQuick picker: Taxi, Hammam, Souks, Food, Guide/Tour, Other\nShows most-used category first (based on recents).\n\n### 3. Price Card Selection\nApp suggests the most likely price card for category.\nUser can switch if needed (e.g., \"Taxi - Airport\" vs \"Taxi - Short ride\").\n\n### 4. Quote Input\n- Numeric keypad for MAD amount\n- Shows price card unit (\"per ride\", \"per person\")\n- Optional quantity if applicable (e.g., 2 people)\n\n### 5. Context Modifiers (Optional)\nToggle relevant adjustments:\n- Night time (after 8pm)\n- Peak season\n- Group size 3+\n- Airport fixed fare\nEach modifier shows how it affects the range.\n\n### 6. Results Screen\n**Fairness Meter** (visual + text):\n- Low: \"Suspiciously cheap — confirm what's included\" (amber)\n- Fair: \"This is a fair price\" (green)\n- High: \"Slightly high — try negotiating\" (terracotta)\n- Very High: \"Well above normal — walk away or negotiate firmly\" (red)\n\n**Price Information**:\n- \"Expected range: 40-60 MAD\"\n- \"Adjusted for night: 50-70 MAD\"\n- \"You were quoted: 100 MAD\"\n- \"Last reviewed: 2026-01-15\"\n\n**Suggested Counter-Offer**:\n- \"Counter with: 50-60 MAD\"\n\n**Scripts** (expandable):\n- Darija (Latin + Arabic)\n- English\n- Optional French\n\n**If Low**:\n- \"Confirm what's included\" checklist\n- Clarification phrases\n\n**If Very High**:\n- \"Walk away\" script\n- \"What to do instead\" alternatives\n\n## PricingEngine Logic\n\n### Inputs\n- priceCard: { expectedCostMinMad, expectedCostMaxMad, fairnessHighMultiplier, lowMultiplier }\n- quotedMAD: number\n- selectedModifiers: [{ factorMin, factorMax, addMin, addMax }]\n- quantity: number (default 1)\n\n### Calculation\n1. Start with base range: [minMad, maxMad]\n2. Apply each modifier:\n   - adjustedMin = minMad * factorMin (or + addMin)\n   - adjustedMax = maxMad * factorMax (or + addMax)\n3. Apply quantity: adjustedMin *= qty, adjustedMax *= qty\n4. Calculate fairness level:\n   - Low: quotedMAD < adjustedMin * lowMultiplier\n   - Fair: adjustedMin <= quotedMAD <= adjustedMax\n   - High: adjustedMax < quotedMAD <= adjustedMax * highMultiplier\n   - VeryHigh: quotedMAD > adjustedMax * highMultiplier\n\n### Outputs\n{\n  adjustedRange: { min, max },\n  fairnessLevel: \"low\" | \"fair\" | \"high\" | \"veryHigh\",\n  suggestedCounterRange: { min, max },\n  scripts: [...],\n  explanation: \"...\",\n  confidence: \"high\" | \"medium\" | \"low\"\n}\n\n## Recent Quotes\n- Store last 10 Quote → Action checks locally\n- Quick access to re-check recent categories\n- Helpful if comparing multiple quotes\n\n## Platform Parity\nPricingEngine MUST produce identical results on iOS and Android.\nUse shared test vectors to verify.\n\n## Offline Requirement\n100% offline. No network calls ever.\nAll data comes from content.db.\n\n## Accessibility\n- Screen reader announces fairness level prominently\n- Scripts expandable and readable\n- Color not the only indicator (text + icon)","status":"open","priority":0,"issue_type":"feature","created_at":"2026-02-07T22:32:36.521643532Z","created_by":"ubuntu","updated_at":"2026-02-07T22:39:34.021312710Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-1pw","depends_on_id":"bd-34f","type":"parent-child","created_at":"2026-02-07T22:32:36.524646498Z","created_by":"ubuntu"},{"issue_id":"bd-1pw","depends_on_id":"bd-3j8","type":"blocks","created_at":"2026-02-07T22:39:34.021294993Z","created_by":"ubuntu"}]}
{"id":"bd-1px","title":"Add context modifiers to remaining price cards","description":"Add context_modifiers for price-hammam-local-basic, price-hammam-tourist-spa, and price-food-street-harira in shared/content/price_cards.json with clear, explainable factor/additive rules.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-07T23:11:01.503008883Z","created_by":"ubuntu","updated_at":"2026-02-07T23:12:39.477176740Z","closed_at":"2026-02-07T23:12:39.477134807Z","close_reason":"Completed: added context modifiers for remaining 3 price cards in shared/content/price_cards.json","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-1px","depends_on_id":"bd-1s9","type":"parent-child","created_at":"2026-02-07T23:11:16.346874606Z","created_by":"ubuntu"}]}
{"id":"bd-1qz","title":"Implement Marrakech theme system (colors, typography, tokens)","description":"# Task: iOS Theme System\n\n## What to Build\nDesign tokens and theme configuration for the Marrakech visual identity.\n\n## Design Identity\nThe app should feel unmistakably rooted in Marrakech:\n- Warm terracotta palette (clay/earth tones)\n- Islamic geometric patterns as accents\n- Premium but not flashy\n\n## Color Palette\n\n### Primary Colors (Terracotta)\n- Terracotta50: #FDF5F2 (lightest)\n- Terracotta100: #FAE6DE\n- Terracotta200: #F5C9B8\n- Terracotta300: #ED9F7F\n- Terracotta400: #E57A4F\n- Terracotta500: #D4572B (primary)\n- Terracotta600: #B84421\n- Terracotta700: #8F341A\n- Terracotta800: #6A2714\n- Terracotta900: #4A1C0F (darkest)\n\n### Neutral Colors\n- Neutral50: #FAFAFA\n- Neutral100: #F5F5F5\n- Neutral200: #E5E5E5\n- Neutral500: #737373\n- Neutral700: #404040\n- Neutral900: #171717\n\n### Semantic Colors\n- Success: #22C55E (green)\n- Warning: #EAB308 (amber)\n- Error: #EF4444 (red)\n- Info: #3B82F6 (blue)\n\n### Fairness Meter Colors\n- FairnessLow: Warning color (suspiciously cheap)\n- FairnessFair: Success color\n- FairnessHigh: Terracotta400 (slightly high)\n- FairnessVeryHigh: Error color\n\n## Typography\n\n### Font Sizes (Dynamic Type supported)\n- largeTitle: 34pt\n- title: 28pt\n- title2: 22pt\n- title3: 20pt\n- headline: 17pt semibold\n- body: 17pt\n- callout: 16pt\n- subheadline: 15pt\n- footnote: 13pt\n- caption: 12pt\n\n### Font Family\n- Use system fonts for readability\n- SF Pro for Latin text\n- System Arabic fonts for Darija\n\n## Spacing Scale\n- xs: 4pt\n- sm: 8pt\n- md: 16pt\n- lg: 24pt\n- xl: 32pt\n- xxl: 48pt\n\n## Corner Radius\n- sm: 4pt\n- md: 8pt\n- lg: 12pt\n- xl: 16pt\n\n## Implementation\n\n### Theme.swift\nenum Theme {\n    static let primaryColor = Color(\"Terracotta500\")\n    // ... all colors\n}\n\n### Color.xcassets\nDefine color sets with light/dark variants:\n- Primary, Secondary, Background, Surface\n- Text colors (primary, secondary, disabled)\n\n### Modifiers\nextension View {\n    func primaryBackground() -> some View\n    func cardStyle() -> some View\n    func sectionHeader() -> some View\n}\n\n## Dark Mode\n- Terracotta hues inverted appropriately\n- Backgrounds become dark, surfaces lighter\n- Text colors inverted\n- Maintain warm identity (not cold blue/purple)\n\n## Verification\n- Colors render correctly in light mode\n- Colors render correctly in dark mode\n- Typography scales with Dynamic Type\n- Spacing is consistent across components","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T22:27:49.041480605Z","created_by":"ubuntu","updated_at":"2026-02-07T23:08:59.681212803Z","closed_at":"2026-02-07T23:08:59.681170038Z","close_reason":"Implemented comprehensive Marrakech theme system for iOS (Theme.swift) and Android (Color.kt, Theme.kt) with full terracotta palette, semantic colors, fairness meter colors, spacing/corner radius tokens, and dark mode support.","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-1qz","depends_on_id":"bd-4aw","type":"parent-child","created_at":"2026-02-07T22:27:49.043897193Z","created_by":"ubuntu"}]}
{"id":"bd-1s9","title":"Shared Content Pipeline — JSON to SQLite Transformation","description":"# Feature: Shared Content Pipeline\n\n## Purpose\nCreate the build system that transforms human-authored JSON content into the SQLite database that both iOS and Android apps consume. This is the single source of truth for all app content.\n\n## Why It Matters\n- Content editors work with readable JSON files\n- Both platforms get identical, validated content\n- Changes are caught before reaching users (schema validation)\n- Internal links are verified (no broken references)\n\n## Location\nAll pipeline code lives in shared/ directory:\n- shared/schema/ — JSON Schema definitions\n- shared/scripts/ — TypeScript build scripts\n- shared/content/ — Source JSON files\n- Output: content.db goes to ios/.../ and android/.../\n\n## Components to Build\n\n### 1. JSON Schema (shared/schema/content-schema.json)\nDefine strict schemas for:\n- places (with all fields from plan.md)\n- price_cards (expected costs, modifiers, scripts)\n- glossary (Darija phrases with Arabic/Latin/English)\n- itineraries (with step references)\n- tips (safety, scam awareness)\n- culture (etiquette do/don't)\n\n### 2. Validation Script (shared/scripts/validate-content.ts)\n- Load all JSON from shared/content/\n- Validate against schema (catch type errors, missing required fields)\n- Enforce invariants: unique IDs, valid coordinates, price min≤max\n- Require updatedAt/reviewedAt dates\n- Exit 0 on success, non-zero with clear errors on failure\n\n### 3. Build Bundle Script (shared/scripts/build-bundle.ts)\n- Read validated JSON\n- Create SQLite database with correct schema\n- Populate all content tables\n- Build FTS5 tables (prebuilt, not at runtime)\n- Generate content_links table from cross-references\n- Output content.db\n\n### 4. Link Checker Script (shared/scripts/check-links.ts)\n- Verify itinerary steps reference valid place IDs\n- Verify tip related_place_ids exist\n- Verify price card relationships are valid\n- Fail build if any broken references\n\n### 5. Seed Content\nMinimal but representative content for development:\n- 5 places (mix of landmarks, restaurants)\n- 5 price cards (taxi, hammam, souk basics)\n- 20 phrases (greetings, bargaining, emergencies)\n- 1 itinerary (single day)\n- 5 tips (common scams, etiquette basics)\n\n## Technical Stack\n- TypeScript for scripts (type safety, good tooling)\n- better-sqlite3 or similar for SQLite generation\n- ajv or zod for JSON validation\n- Node.js runtime\n\n## Success Criteria\n- npm run validate passes on all content\n- npm run build produces content.db\n- npm run check-links finds no broken references\n- Generated DB has all tables with correct schema\n- FTS tables are populated and searchable\n- Both platforms can load the same content.db\n\n## Integration Points\n- iOS: Copy content.db to ios/MarrakechGuide/Resources/SeedData/\n- Android: Copy content.db to android/app/src/main/assets/seed/\n- CI: Run validation + build on every PR\n\n## File Outputs\n- shared/schema/content-schema.json\n- shared/scripts/validate-content.ts\n- shared/scripts/build-bundle.ts\n- shared/scripts/check-links.ts\n- shared/scripts/package.json\n- content.db (generated, not committed)","status":"closed","priority":0,"issue_type":"feature","created_at":"2026-02-07T22:25:05.890949201Z","created_by":"ubuntu","updated_at":"2026-02-08T21:35:58.281165337Z","closed_at":"2026-02-08T21:35:58.281130826Z","close_reason":"Content pipeline complete: validate-content.ts, build-bundle.ts, check-links.ts all working. content.db generated (284KB). Schema validation passes.","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-1s9","depends_on_id":"bd-3lc","type":"parent-child","created_at":"2026-02-07T22:25:05.895237124Z","created_by":"ubuntu"}]}
{"id":"bd-1u0","title":"Home Screen — The Command Center","description":"# Feature: Home Screen\n\n## Purpose\nThe first screen users see. Provides quick access to high-value features and surfaces timely, useful information.\n\n## Why This Matters\nHome screen sets the tone:\n- Shows app is useful immediately (quick actions)\n- Proves value on every open (Tip of the Day)\n- Reduces friction to key features (1-tap to Quote → Action)\n- Shows app status at a glance (Offline Ready chip)\n\n## Screen Layout\n\n### Top Section: Quick Actions Grid\nHigh-contrast buttons for the most common needs:\n1. **Check a Price** → Quote → Action\n2. **My Day** → Daily plan builder\n3. **Go Home** → Home Base compass\n4. **Taxi Prices** → Taxi price cards\n5. **Phrasebook** → Darija phrases\n6. **Currency** → Converter tool\n\nGrid layout: 2x3 on phone, 3x2 on larger screens.\n\n### Active Route Banner (Conditional)\nShows only when user has an active Route Card:\n- \"Continue: Bahia Palace → Cafe Clock\"\n- Progress: \"3/6 stops\"\n- \"Continue\" button → Route Cards\n\n### Offline Status Chip\nAlways visible, one of:\n- ✓ \"Offline Ready\" (green) — all core content loaded\n- ⬇️ \"Download Recommended\" (amber) → Downloads\n- ⚠️ \"Update Available\" (info) → Downloads\n\n### Today's Tip\nRotating practical tip:\n- Title + brief preview\n- Tap for full tip\n- Different tip each day (deterministic by date)\n\n### Phrase of the Day\nDaily Darija phrase:\n- Latin + Arabic + English\n- Tap for detail + audio\n- Different phrase each day\n\n### Saved Items (if any)\nHorizontal scroll of favorited items:\n- Places, price cards, phrases\n- Empty state: \"Save items for quick access\"\n\n### Recently Viewed (if any)\nLast 5 viewed items:\n- Quick re-access\n- Empty state: \"Your recent items will appear here\"\n\n## Implementation\n\n### HomeView/Screen\n- Pull-to-refresh (updates \"Open now\" status, tip rotation)\n- All data from local DB (100% offline)\n- Quick action routing to appropriate features\n\n### HomeViewModel\n- Load favorites, recents from UserRepository\n- Select Tip/Phrase of the Day (hash of date → index)\n- Check active route status\n- Check offline readiness status\n\n### OfflineStatusChip\nLogic:\n- Check content.db integrity\n- Check if recommended packs downloaded\n- Show appropriate status\n\n## Accessibility\n- Quick actions have clear labels\n- Focus order: quick actions → active route → tip → phrase → saved → recents\n- All interactive elements ≥44pt/48dp\n\n## Success Criteria\n- Users can reach Quote → Action in 1 tap\n- Users can resume Route Cards in 1 tap\n- Offline status is always visible\n- Today's content changes daily","status":"open","priority":0,"issue_type":"feature","created_at":"2026-02-07T22:47:02.203571275Z","created_by":"ubuntu","updated_at":"2026-02-07T22:50:49.376251674Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-1u0","depends_on_id":"bd-34f","type":"parent-child","created_at":"2026-02-07T22:47:02.206741250Z","created_by":"ubuntu"},{"issue_id":"bd-1u0","depends_on_id":"bd-3j8","type":"blocks","created_at":"2026-02-07T22:50:49.376235100Z","created_by":"ubuntu"}]}
{"id":"bd-1v5","title":"Implement standard screen state components (loading, error, offline)","description":"# Task: Standard Screen State Components\n\n## What to Build\nReusable components for the five standard screen states that every screen must support.\n\n## Why This Matters\nConsistent state handling:\n- Prevents blank screens (loading shows skeleton)\n- Clear error recovery (error shows action)\n- Calm offline messaging (not scary)\n- Professional feel throughout app\n\n## The Five States\n\n### 1. Loading State\n- Show skeleton/placeholder matching content shape\n- Never show blank screen\n- Animate shimmer effect\n- Accessible: announce \"Loading\"\n\n### 2. Content State\n- Normal display\n- This is what components already do\n\n### 3. Refreshing State\n- Content still visible\n- Subtle progress indicator (pull-to-refresh or overlay)\n- Don't block interaction\n\n### 4. Offline State\n- Show cached content if available\n- Banner: \"Offline • Core guide still works\"\n- Calm, not alarming\n- Actions still work where possible\n\n### 5. Error State\n- Clear error message\n- What went wrong (brief)\n- What to do next (action button)\n- Options: Retry, Go to Downloads, Work Offline\n\n## Components to Build\n\n### iOS (SwiftUI)\n\n#### LoadingView<Content>\n@ViewBuilder content: () -> Content  // Skeleton shape\n\n#### OfflineBanner\nvar onDismiss: () -> Void\n\n#### ErrorView\nvar message: String\nvar retryAction: (() -> Void)?\nvar alternativeActions: [ErrorAction]\n\n#### RefreshableContent\nUsing .refreshable modifier\n\n### Android (Compose)\n\n#### LoadingContent\n@Composable content: () -> Unit  // Skeleton shape\n\n#### OfflineBanner\nonDismiss: () -> Unit\n\n#### ErrorContent\nmessage: String\nonRetry: (() -> Unit)?\nalternativeActions: List<ErrorAction>\n\n#### PullToRefresh\nUsing Modifier.pullRefresh\n\n## State Container Pattern\n\n### ScreenState<T>\nenum ScreenState<T> {\n    case loading\n    case content(T)\n    case refreshing(T)\n    case offline(T?)  // cached content optional\n    case error(Error)\n}\n\n### Usage in ViewModel\n@Published var state: ScreenState<[Place]> = .loading\n\nfunc load() {\n    state = .loading\n    do {\n        let places = try await repository.getPlaces()\n        state = .content(places)\n    } catch {\n        if let cached = cachedPlaces {\n            state = .offline(cached)\n        } else {\n            state = .error(error)\n        }\n    }\n}\n\n## Skeleton Patterns\n\n### List Skeleton\n- 5-7 placeholder rows\n- Row shape matches actual content\n- Animated shimmer\n\n### Card Skeleton\n- Matches Card component shape\n- Title bar + content area\n\n### Detail Skeleton\n- Hero image placeholder\n- Title bar\n- Content blocks\n\n## Accessibility\n- Loading announced\n- Error announced with message\n- Retry buttons accessible\n- Offline banner dismissible via gesture\n\n## Success Criteria\n- Every screen uses ScreenState pattern\n- No blank screens during load\n- Errors always have recovery action\n- Offline state is calm and usable","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T22:50:01.539621846Z","created_by":"ubuntu","updated_at":"2026-02-08T21:38:10.974705047Z","closed_at":"2026-02-08T21:38:10.974661031Z","close_reason":"Completed: implemented iOS screen-state components and wired all five tab roots","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-1v5","depends_on_id":"bd-4aw","type":"parent-child","created_at":"2026-02-07T22:50:01.546064508Z","created_by":"ubuntu"}]}
{"id":"bd-20q","title":"Implement PlaceRepository (iOS + Android)","description":"# Task: PlaceRepository\n\n## What to Build\nRepository for accessing place data on both platforms.\n\n## Interface\n\n### Swift (iOS)\nprotocol PlaceRepository {\n    func getAllPlaces() async throws -> [Place]\n    func getPlace(id: String) async throws -> Place?\n    func getPlaces(category: PlaceCategory) async throws -> [Place]\n    func getPlaces(region: String) async throws -> [Place]\n    func searchPlaces(query: String, limit: Int) async throws -> [Place]\n    func getOpenNowPlaces() async throws -> [Place]\n    func getRelatedPriceCards(placeId: String) async throws -> [PriceCard]\n    func getRelatedPhrases(placeId: String) async throws -> [GlossaryPhrase]\n}\n\n### Kotlin (Android)\ninterface PlaceRepository {\n    fun getAllPlaces(): Flow<List<Place>>\n    suspend fun getPlace(id: String): Place?\n    fun getPlacesByCategory(category: PlaceCategory): Flow<List<Place>>\n    fun getPlacesByRegion(region: String): Flow<List<Place>>\n    suspend fun searchPlaces(query: String, limit: Int = 20): List<Place>\n    fun getOpenNowPlaces(): Flow<List<Place>>\n    suspend fun getRelatedPriceCards(placeId: String): List<PriceCard>\n    suspend fun getRelatedPhrases(placeId: String): List<GlossaryPhrase>\n}\n\n## Key Queries\n\n### Get all places\nSELECT * FROM places ORDER BY name\n\n### Filter by category\nSELECT * FROM places WHERE category = ? ORDER BY name\n\n### FTS Search\nSELECT places.* FROM places\nJOIN places_fts ON places.rowid = places_fts.rowid\nWHERE places_fts MATCH ?\nORDER BY rank\nLIMIT ?\n\n### Open now (requires time calculation)\nCheck current time against hours_weekly JSON\n\n### Related items via content_links\nSELECT price_cards.* FROM price_cards\nJOIN content_links ON content_links.to_id = price_cards.id\nWHERE content_links.from_type = 'place'\nAND content_links.from_id = ?\nAND content_links.to_type = 'price_card'\n\n## Model Mapping\n- Database entities → Domain models\n- Handle null/missing fields gracefully\n- Parse JSON arrays (tags, localTips, images)\n\n## Platform Parity\n- Same interface shape\n- Same query results\n- Same error handling patterns","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T22:31:04.109888505Z","created_by":"ubuntu","updated_at":"2026-02-07T23:27:51.902948873Z","closed_at":"2026-02-07T23:27:51.902847550Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-20q","depends_on_id":"bd-3j8","type":"parent-child","created_at":"2026-02-07T22:31:04.113044209Z","created_by":"ubuntu"}]}
{"id":"bd-26j","title":"Android Foundation — Kotlin/Compose App Shell","description":"# Feature: Android Foundation\n\n## Purpose\nSet up the Android Gradle project with foundational infrastructure: navigation, database layer, theming, and basic components. This mirrors the iOS foundation for platform parity.\n\n## Why It Matters\n- Ensures Android gets equal attention (not an afterthought)\n- Establishes patterns that all Android features follow\n- Provides identical user experience across platforms\n\n## What Gets Built\n\n### 1. Gradle Project Structure\nandroid/\n├── app/\n│   ├── build.gradle.kts\n│   └── src/main/\n│       ├── kotlin/com/marrakechguide/\n│       │   ├── MarrakechGuideApp.kt\n│       │   ├── MainActivity.kt\n│       │   ├── core/\n│       │   ├── feature/\n│       │   ├── ui/\n│       │   └── di/\n│       ├── res/\n│       └── assets/seed/\n├── build.gradle.kts\n└── settings.gradle.kts\n\n### 2. Database Layer (Room)\n- ContentDatabase.kt: Read-only Room database for content\n- UserDatabase.kt: Read-write for user state\n- DatabaseManager.kt: Lifecycle management\n- DAOs for each entity type\n- TypeConverters for JSON arrays\n\n### 3. Navigation\n- Jetpack Navigation Compose\n- Bottom Navigation Bar (5 destinations)\n- Predictive back gesture support\n\n### 4. Theme System\n- Material 3 with custom color scheme\n- Marrakech terracotta palette\n- Dark theme support\n- Design tokens matching iOS\n\n### 5. Basic Components\n- Card, Chip, PriceTag (Compose versions)\n- SectionHeader\n- OfflineBanner\n- Skeleton/placeholder composables\n\n## Technical Stack\n- Kotlin 1.9+\n- Jetpack Compose (BOM latest stable)\n- Room for SQLite\n- Hilt for dependency injection\n- Coroutines for async\n\n## Key Decisions Made Here\n- Room over SQLite directly (better Android integration)\n- Hilt for DI (standard, well-supported)\n- Material 3 for modern Android look\n- Feature-based package structure\n\n## Success Criteria\n- Project builds without errors\n- Bottom navigation works\n- Content.db loads from assets\n- User.db initializes on first run\n- Theme applies consistently\n- Components match iOS counterparts\n\n## Platform Parity\nEnsure these match iOS exactly:\n- Navigation structure (5 tabs)\n- Color palette and semantic colors\n- Component behavior and appearance\n- Database schema","status":"closed","priority":0,"issue_type":"feature","created_at":"2026-02-07T22:28:25.797149208Z","created_by":"ubuntu","updated_at":"2026-02-08T21:36:38.627483475Z","closed_at":"2026-02-08T21:36:38.627438808Z","close_reason":"Android Foundation complete: Gradle project, Room database, Core (database, repository, engine, model, service), Features structure, Hilt DI ready.","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-26j","depends_on_id":"bd-3lc","type":"parent-child","created_at":"2026-02-07T22:28:25.799564004Z","created_by":"ubuntu"}]}
{"id":"bd-274","title":"Implement 'Open Now' hours calculation logic","description":"# Task: \"Open Now\" Hours Logic\n\n## What to Build\nCalculate whether a place is currently open based on structured hours data.\n\n## Why This is Non-Trivial\n- Weekly hours are complex (different per day)\n- Morocco timezone is tricky (Africa/Casablanca with irregular DST)\n- Ramadan hours differ from normal\n- Holiday exceptions exist\n- Many places have incomplete data\n\n## Data Structure (from places.json)\n\n### hours_weekly (JSON array)\n[\n  { \"day\": \"monday\", \"open\": \"09:00\", \"close\": \"18:00\" },\n  { \"day\": \"tuesday\", \"open\": \"09:00\", \"close\": \"18:00\" },\n  { \"day\": \"friday\", \"open\": \"09:00\", \"close\": \"13:00\", \"note\": \"Friday prayer\" },\n  { \"day\": \"sunday\", \"closed\": true }\n]\n\n### hours_exceptions (JSON array)\n[\n  { \"date\": \"2026-03-10\", \"note\": \"Ramadan start\", \"open\": \"09:00\", \"close\": \"15:00\" },\n  { \"period\": \"ramadan\", \"open\": \"09:00\", \"close\": \"15:00\" }\n]\n\n## Interface\n\n### HoursService\nprotocol HoursService {\n    func isOpen(place: Place, at: Date) -> OpenStatus\n    func getNextChange(place: Place, from: Date) -> HoursChange?\n    func formatHoursForDisplay(place: Place) -> String\n}\n\nenum OpenStatus {\n    case open(closesAt: Date)\n    case closed(opensAt: Date?)\n    case unknown  // no hours data\n}\n\nstruct HoursChange {\n    let time: Date\n    let type: ChangeType  // .opens or .closes\n}\n\n## Algorithm\n\n### isOpen(place, at)\n1. Check hours_exceptions for specific date match\n2. Check hours_exceptions for period match (Ramadan)\n3. Fall back to hours_weekly for day of week\n4. Parse open/close times in Morocco timezone\n5. Compare with current time\n6. Return open status with next transition\n\n### Timezone Handling\n- All times in data are Morocco local time\n- App must convert to Morocco timezone before comparison\n- Morocco uses Africa/Casablanca (has irregular DST, sometimes none)\n\n### Ramadan Detection\n- Can be hardcoded for near-term (2026: Mar 1 - Mar 30)\n- Or use external data source\n- If in Ramadan period, check for Ramadan exception hours\n\n## Display Formatting\n\n### formatHoursForDisplay(place)\nOutputs:\n- \"Open now · Closes 6 PM\"\n- \"Closed · Opens 9 AM tomorrow\"\n- \"Open 9 AM - 6 PM (Mon-Sat)\"\n- \"Hours vary\" (if exceptions/complex)\n\n## Edge Cases\n\n### 24-Hour Places\n{ \"day\": \"monday\", \"open\": \"00:00\", \"close\": \"23:59\" }\n\n### Overnight Hours\n{ \"day\": \"friday\", \"open\": \"20:00\", \"close\": \"02:00\" }\nCloses after midnight Saturday.\n\n### No Hours Data\nReturn .unknown, UI shows \"Check hours locally\"\n\n### Stale Hours Data\nIf hours_verified_at > 6 months ago, show warning.\n\n## Test Cases\n\n### Case 1: Simple Open\nPlace open 9-18, current time 14:00\nAssert: .open(closesAt: 18:00)\n\n### Case 2: After Hours\nPlace open 9-18, current time 20:00\nAssert: .closed(opensAt: tomorrow 9:00)\n\n### Case 3: Ramadan Override\nNormal hours 9-18, Ramadan hours 9-15\nDuring Ramadan at 16:00\nAssert: .closed(opensAt: tomorrow 9:00)\n\n### Case 4: Friday Prayer\nFriday hours 9-13, current Friday 14:00\nAssert: .closed(opensAt: Saturday 9:00)","status":"in_progress","priority":1,"issue_type":"task","created_at":"2026-02-07T22:48:43.543926122Z","created_by":"ubuntu","updated_at":"2026-02-08T21:37:43.452757062Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-274","depends_on_id":"bd-20q","type":"blocks","created_at":"2026-02-07T22:50:49.544558482Z","created_by":"ubuntu"},{"issue_id":"bd-274","depends_on_id":"bd-3j8","type":"parent-child","created_at":"2026-02-07T22:48:43.547028555Z","created_by":"ubuntu"}]}
{"id":"bd-2bl","title":"Route Cards — Step-by-Step Itinerary Execution","description":"# Feature: Route Cards\n\n## Purpose\nGuide users through itineraries step-by-step with compass direction, distance, and progress tracking.\n\n## Why This Matters\nHaving a plan is only half the battle. Executing it in an unfamiliar city requires:\n- Clear \"what's next\" guidance\n- Direction to the next stop\n- Confidence about timing\n- Easy progress tracking\n\n## Screens\n\n### RouteOverviewView/Screen\nEntry point for a route:\n- Route name (itinerary title or \"My Day Plan\")\n- Total stops: 6\n- Estimated total time: 5 hours\n- Progress: 2/6 complete\n- List of all stops:\n  - Stop name\n  - Estimated time\n  - Completed indicator\n- \"Continue Route\" button → NextStopView\n- \"Exit Route\" with confirmation\n\n### NextStopView/Screen (The Core)\nCurrent navigation view:\n- **Current Stop**: \"Bahia Palace\" (if at a stop)\n  - \"Mark as Done\" button\n- **Next Stop**: \"Cafe Clock\"\n  - Name prominently displayed\n  - Quick facts (open now, expected time)\n- **Navigation Panel**:\n  - Compass arrow pointing to next stop\n  - Distance: \"450 m\"\n  - Walk time estimate: \"7 min\"\n  - Heading confidence indicator\n- **Actions**:\n  - \"Skip This Stop\" → move to next\n  - \"Stop Here\" → pause with GPS tracking\n  - \"Need Help\" → phrase card for asking directions\n- **Route Hint** (if available):\n  - \"Exit Bahia Palace, turn left, walk toward the minaret\"\n\n### MedinaModeView (Fallback)\nWhen GPS/heading is unreliable:\n- Simplified display\n- Direction + distance (no compass animation)\n- \"Ask for Directions\" phrase card (large text)\n- Landmark hints from route data\n- \"I've Arrived\" manual button\n\n## Route Progress\n\n### State Model\n{\n  routeId: \"itinerary-first-day\" | \"plan-20260215-1\",\n  currentStepIndex: 2,\n  startedAt: \"2026-02-15T09:00:00\",\n  stepsCompleted: [0, 1],\n  stepsSkipped: [],\n  pausedAt: null\n}\n\nPersisted to user.db, survives app restart.\n\n### Step Completion\nWhen user taps \"Mark as Done\":\n- Record completion\n- Advance to next step\n- Update progress UI\n- If last step: show completion celebration\n\n### Skip Logic\nWhen user taps \"Skip\":\n- Mark step as skipped (not completed)\n- Advance to next step\n- Route continues (don't recalculate)\n\n## RouteEngine\n\n### Interface\nprotocol RouteEngine {\n    func startRoute(itinerary: Itinerary) -> RouteProgress\n    func startRoute(plan: Plan) -> RouteProgress\n    func getCurrentLeg(progress: RouteProgress) -> RouteLeg\n    func completeCurrentStep(progress: inout RouteProgress)\n    func skipCurrentStep(progress: inout RouteProgress)\n}\n\nstruct RouteLeg {\n    let fromPlace: Place?  // nil if first step\n    let toPlace: Place\n    let distanceMeters: Double\n    let bearingDegrees: Double\n    let estimatedWalkMinutes: Int\n    let routeHint: String?\n}\n\n### Calculations\nUses GeoEngine for:\n- Distance from current location to next stop\n- Bearing for compass arrow\n- Relative angle for arrow rotation\n\n## Offline Guarantee\n100% offline. All guidance from local data + GPS.\n\n## Accessibility\n- Announce: \"Next stop is Cafe Clock, 450 meters to the east\"\n- Large touch targets\n- Screen reader navigation logical","status":"open","priority":1,"issue_type":"feature","created_at":"2026-02-07T22:36:39.943927074Z","created_by":"ubuntu","updated_at":"2026-02-07T22:39:42.036557382Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-2bl","depends_on_id":"bd-1iv","type":"blocks","created_at":"2026-02-07T22:39:41.971049545Z","created_by":"ubuntu"},{"issue_id":"bd-2bl","depends_on_id":"bd-2g9","type":"blocks","created_at":"2026-02-07T22:39:42.036538734Z","created_by":"ubuntu"},{"issue_id":"bd-2bl","depends_on_id":"bd-37x","type":"parent-child","created_at":"2026-02-07T22:36:39.947247264Z","created_by":"ubuntu"}]}
{"id":"bd-2dp","title":"Implement Currency Converter tool","description":"# Task: Currency Converter Tool\n\n## What to Build\nSimple MAD ↔ Home Currency converter for quick mental math.\n\n## Why This is Useful\nTourists constantly need to know \"Is 500 MAD a lot?\"\n- Helps evaluate prices quickly\n- Useful in Quote → Action context\n- High perceived value for simple feature\n\n## UX\n\n### ConverterView/Screen\n- Two input fields: MAD / Home Currency\n- Typing in one updates the other\n- Current rate displayed: \"1 USD = 10.2 MAD\"\n- Last updated timestamp\n- \"Update Rate\" button (optional, for manual entry)\n\n### Quick Access\n- Home screen quick action\n- Can invoke from Quote → Action results\n- Accessible from Settings\n\n## Data\n\n### Exchange Rate Storage\nStored in user.db user_settings:\n{\n  \"exchangeRate\": {\n    \"currency\": \"USD\",\n    \"rate\": 10.2,\n    \"updatedAt\": \"2026-02-15T09:00:00\"\n  }\n}\n\n### Default Rates (Hardcoded Fallbacks)\nUSD: 10.0\nEUR: 11.0\nGBP: 12.5\nCAD: 7.5\n\n## Implementation\n\n### Calculation\nSimple division/multiplication:\nhomeAmount = madAmount / rate\nmadAmount = homeAmount * rate\n\n### Input Handling\n- Numeric keyboard\n- Allow decimals\n- Clear on focus\n- Update on every keystroke (debounced)\n\n### Currency Selection\nFrom onboarding or Settings:\n- Picker with common currencies\n- USD, EUR, GBP, CAD, AUD, CHF\n\n## Offline Guarantee\nWorks 100% offline using stored rate.\nUser manually updates rate if needed.\n\n## Future Enhancement (Not v1)\n- Fetch live rate when online\n- Show rate source\n- Historical rate chart","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-07T22:49:40.641608281Z","created_by":"ubuntu","updated_at":"2026-02-07T22:49:40.644139179Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-2dp","depends_on_id":"bd-34f","type":"parent-child","created_at":"2026-02-07T22:49:40.644118237Z","created_by":"ubuntu"}]}
{"id":"bd-2g9","title":"Implement remaining content repositories (Phrase, Itinerary, Tip, Culture)","description":"# Task: Remaining Content Repositories\n\n## What to Build\nRepositories for phrases, itineraries, tips, and culture content.\n\n## PhraseRepository\nprotocol PhraseRepository {\n    func getAllPhrases() async throws -> [GlossaryPhrase]\n    func getPhrases(category: String) async throws -> [GlossaryPhrase]\n    func searchPhrases(query: String) async throws -> [GlossaryPhrase]\n    func getPhrase(id: String) async throws -> GlossaryPhrase?\n}\n\nFields: id, category, arabic (RTL), latin, english, audio (optional)\nSearch: FTS on latin + english (Arabic search is complex, defer)\n\n## ItineraryRepository\nprotocol ItineraryRepository {\n    func getAllItineraries() async throws -> [Itinerary]\n    func getItinerary(id: String) async throws -> Itinerary?\n    func getSteps(itineraryId: String) async throws -> [ItineraryStep]\n}\n\nFields: id, title, duration, steps (JSON array)\nSteps contain: type, placeId/activityId, estimatedMinutes, routeHint\n\n## TipRepository\nprotocol TipRepository {\n    func getAllTips() async throws -> [Tip]\n    func getTips(category: String) async throws -> [Tip]\n    func getTip(id: String) async throws -> Tip?\n    func getTipsFor(placeId: String) async throws -> [Tip]\n    func getTipsFor(priceCardId: String) async throws -> [Tip]\n}\n\nFields: id, title, content, category, relatedPlaceIds, relatedPriceCardIds\n\n## CultureRepository\nprotocol CultureRepository {\n    func getAllCultureArticles() async throws -> [CultureArticle]\n    func getCultureArticle(id: String) async throws -> CultureArticle?\n}\n\nFields: id, title, content, category, doAndDont (JSON array)\n\n## Shared Patterns\n- All use content.db (read-only)\n- All handle JSON array parsing\n- All support search where meaningful\n- All return domain models, not entities","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T22:31:31.482010207Z","created_by":"ubuntu","updated_at":"2026-02-07T23:32:28.618377499Z","closed_at":"2026-02-07T23:32:28.618305400Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-2g9","depends_on_id":"bd-3j8","type":"parent-child","created_at":"2026-02-07T22:31:31.484138715Z","created_by":"ubuntu"}]}
{"id":"bd-2gt","title":"Accessibility — VoiceOver, TalkBack, and Inclusive Design","description":"# Feature: Accessibility\n\n## Purpose\nEnsure the app is usable by everyone, including users with visual, motor, or cognitive disabilities.\n\n## Why This Matters\n- It's the right thing to do\n- Required by app store guidelines\n- Extends audience reach\n- Improves UX for everyone\n\n## Requirements\n\n### Screen Reader Support\n\n#### iOS (VoiceOver)\n- All interactive elements have labels\n- Images have descriptions or marked decorative\n- Correct trait hints (button, heading, etc.)\n- Logical focus order\n- Rotor actions where helpful\n\n#### Android (TalkBack)\n- All interactive elements have contentDescription\n- Images have descriptions or importantForAccessibility=\"no\"\n- Correct semantics (Role.Button, heading levels)\n- Logical focus order\n- Actions accessible\n\n### Dynamic Type / Font Scaling\n\n#### iOS\n- Use system Text Styles (.body, .headline, etc.)\n- Test at all accessibility sizes\n- Layout adjusts (no truncation of critical info)\n- Minimum touch targets maintained\n\n#### Android\n- Use sp units for text\n- Test at 200% font scale\n- Layout adjusts appropriately\n- Minimum touch targets maintained\n\n### Touch Targets\n- iOS: Minimum 44×44 pt\n- Android: Minimum 48×48 dp\n- Adequate spacing between targets\n- No overlapping touch areas\n\n### Color Contrast\n- Text: 4.5:1 minimum contrast ratio\n- Large text: 3:1 minimum\n- Interactive elements: 3:1 minimum\n- Test with color blindness simulators\n\n### Color Not Sole Indicator\n- Fairness meter: color + icon + text\n- Status indicators: color + text/icon\n- Error states: color + icon + message\n\n### Focus Indicators\n- Visible focus for keyboard/switch control\n- Maintain system focus rings\n- Custom focus states match platform\n\n## RTL Support (Arabic)\n- Layout mirrors for RTL languages\n- Arabic text renders correctly\n- Mixed RTL/LTR handled\n- Tested with Arabic system language\n\n## Reduce Motion\n- Respect system \"Reduce Motion\" setting\n- Disable compass animation if reduced\n- Simpler transitions\n\n## Testing Protocol\n1. **VoiceOver smoke test** (iOS):\n   - Navigate all tabs\n   - Complete Quote → Action\n   - Use Go Home compass\n   - Search for content\n\n2. **TalkBack smoke test** (Android):\n   - Same flows as iOS\n\n3. **Large text test**:\n   - iOS: Largest accessibility size\n   - Android: 200% font scale\n\n4. **Contrast test**:\n   - Run accessibility scanner\n   - Check all states (normal, pressed, disabled)\n\n## Success Criteria\n- Blind user can complete all core flows\n- Low vision user can read all content\n- Motor-impaired user can navigate efficiently\n- App meets WCAG 2.1 AA guidelines","status":"open","priority":1,"issue_type":"feature","created_at":"2026-02-07T22:37:51.359017097Z","created_by":"ubuntu","updated_at":"2026-02-07T22:37:51.362557397Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-2gt","depends_on_id":"bd-1eo","type":"parent-child","created_at":"2026-02-07T22:37:51.362522144Z","created_by":"ubuntu"}]}
{"id":"bd-2hz","title":"Build SQLite bundle generator (build-bundle.ts)","description":"# Task: SQLite Bundle Generator\n\n## What to Build\nCreate shared/scripts/build-bundle.ts that transforms JSON content into SQLite content.db.\n\n## Functionality\n\n### Input\n- Validated JSON from shared/content/\n- Assumes validate-content.ts has already passed\n\n### Output\n- content.db with all content tables\n- Prebuilt FTS5 tables for search\n- content_links table for cross-references\n\n### Database Schema\n\n#### places table\nCREATE TABLE places (\n    id TEXT PRIMARY KEY,\n    name TEXT NOT NULL,\n    aliases TEXT,  -- JSON array\n    region_id TEXT,\n    category TEXT,\n    short_description TEXT,\n    long_description TEXT,\n    reviewed_at TEXT,\n    status TEXT DEFAULT 'open',\n    confidence TEXT,\n    tourist_trap_level TEXT,\n    neighborhood TEXT,\n    address TEXT,\n    lat REAL,\n    lng REAL,\n    hours_text TEXT,\n    hours_weekly TEXT,  -- JSON array\n    hours_verified_at TEXT,\n    fees_min_mad INTEGER,\n    fees_max_mad INTEGER,\n    expected_cost_min_mad INTEGER,\n    expected_cost_max_mad INTEGER,\n    visit_min_minutes INTEGER,\n    visit_max_minutes INTEGER,\n    best_time_to_go TEXT,\n    tags TEXT,  -- JSON array\n    local_tips TEXT,  -- JSON array\n    scam_warnings TEXT,  -- JSON array\n    images TEXT  -- JSON array\n);\n\n#### price_cards table\nCREATE TABLE price_cards (\n    id TEXT PRIMARY KEY,\n    title TEXT NOT NULL,\n    category TEXT,\n    unit TEXT,\n    volatility TEXT,\n    confidence TEXT,\n    expected_cost_min_mad INTEGER NOT NULL,\n    expected_cost_max_mad INTEGER NOT NULL,\n    expected_cost_updated_at TEXT,\n    what_influences_price TEXT,  -- JSON array\n    negotiation_scripts TEXT,  -- JSON array\n    red_flags TEXT,  -- JSON array\n    context_modifiers TEXT,  -- JSON array\n    fairness_high_multiplier REAL DEFAULT 1.25\n);\n\n#### phrases table\nCREATE TABLE phrases (\n    id TEXT PRIMARY KEY,\n    category TEXT,\n    arabic TEXT,\n    latin TEXT,\n    english TEXT,\n    audio TEXT\n);\n\n#### itineraries table\nCREATE TABLE itineraries (\n    id TEXT PRIMARY KEY,\n    title TEXT NOT NULL,\n    duration TEXT,\n    steps TEXT  -- JSON array\n);\n\n#### tips table\nCREATE TABLE tips (\n    id TEXT PRIMARY KEY,\n    title TEXT NOT NULL,\n    content TEXT NOT NULL,\n    category TEXT,\n    related_place_ids TEXT,  -- JSON array\n    related_price_card_ids TEXT  -- JSON array\n);\n\n#### culture table\nCREATE TABLE culture (\n    id TEXT PRIMARY KEY,\n    title TEXT NOT NULL,\n    content TEXT NOT NULL,\n    category TEXT,\n    do_and_dont TEXT  -- JSON array\n);\n\n### FTS5 Tables (Prebuilt)\nCREATE VIRTUAL TABLE places_fts USING fts5(\n    id, name, aliases, short_description, long_description, tags,\n    content='places', content_rowid='rowid'\n);\n\nCREATE VIRTUAL TABLE price_cards_fts USING fts5(\n    id, title, category,\n    content='price_cards', content_rowid='rowid'\n);\n\nCREATE VIRTUAL TABLE phrases_fts USING fts5(\n    id, arabic, latin, english,\n    content='phrases', content_rowid='rowid'\n);\n\n### content_links table\nCREATE TABLE content_links (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    from_type TEXT,\n    from_id TEXT,\n    to_type TEXT,\n    to_id TEXT,\n    link_kind TEXT\n);\n\nPopulate from related_place_ids, related_price_card_ids in content.\n\n## Technical Notes\n- Use better-sqlite3 for synchronous SQLite operations\n- Create WAL mode disabled for read-only distribution\n- Verify FTS indexes work with test queries\n- Output goes to shared/output/content.db (not committed)\n\n## Integration\n- npm run build runs this after npm run validate\n- CI copies output to iOS and Android seed locations","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T22:25:52.069027134Z","created_by":"ubuntu","updated_at":"2026-02-07T23:10:06.593845709Z","closed_at":"2026-02-07T23:10:06.593812510Z","close_reason":"Created build-bundle.ts using Bun SQLite. Generates content.db (284 KB) with 163 items across 8 tables, FTS5 search indexes, and content_links. Verified search works (tested 'palace' query).","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-2hz","depends_on_id":"bd-1s9","type":"parent-child","created_at":"2026-02-07T22:25:52.071953348Z","created_by":"ubuntu"},{"issue_id":"bd-2hz","depends_on_id":"bd-vk1","type":"blocks","created_at":"2026-02-07T22:30:29.684428852Z","created_by":"ubuntu"}]}
{"id":"bd-2jn","title":"Set up CI gates (content validation, builds, tests, lint)","description":"# Task: CI Gates Setup\n\n## What to Build\nAutomated checks that run on every PR to catch issues before merge.\n\n## Gates\n\n### 1. Content Pipeline Gate\nRuns on: Changes to shared/content/* or shared/scripts/*\n\n- npm run validate — Schema validation\n- npm run check-links — Reference validation\n- npm run build — Generate content.db\n- Verify content.db has expected tables/counts\n\n### 2. iOS Build Gate\nRuns on: Changes to ios/* or shared/*\n\n- xcodebuild build -scheme MarrakechGuide\n- SwiftLint (if configured)\n- SwiftFormat --lint\n\n### 3. iOS Test Gate\nRuns on: Changes to ios/* or shared/*\n\n- xcodebuild test -scheme MarrakechGuide\n- Load shared test vectors\n- Engine tests must pass\n\n### 4. Android Build Gate\nRuns on: Changes to android/* or shared/*\n\n- ./gradlew assembleDebug\n- ./gradlew lint\n- ./gradlew ktlintCheck\n\n### 5. Android Test Gate\nRuns on: Changes to android/* or shared/*\n\n- ./gradlew test\n- Load shared test vectors\n- Engine tests must pass\n\n### 6. Cross-Platform Parity Gate\nRuns on: Changes to shared/tests/*\n\n- Both iOS and Android test suites run\n- Same vectors, same expected results\n\n### 7. Security Gate\nRuns on: All PRs\n\n- Check for forbidden permissions (AndroidManifest)\n- Check for secrets in code\n- Dependency vulnerability scan\n\n### 8. Store Policy Gate\nRuns on: Release branches\n\n- iOS SDK version meets App Store requirement\n- Android target SDK meets Play Store requirement\n\n## GitHub Actions Workflow\n\nname: CI\non: [pull_request, push]\n\njobs:\n  content:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - uses: actions/setup-node@v4\n      - run: npm ci --prefix shared\n      - run: npm run validate --prefix shared\n      - run: npm run check-links --prefix shared\n      - run: npm run build --prefix shared\n\n  ios:\n    runs-on: macos-latest\n    needs: content\n    steps:\n      - uses: actions/checkout@v4\n      - run: xcodebuild build -scheme MarrakechGuide\n      - run: xcodebuild test -scheme MarrakechGuide\n\n  android:\n    runs-on: ubuntu-latest\n    needs: content\n    steps:\n      - uses: actions/checkout@v4\n      - uses: actions/setup-java@v4\n      - run: ./gradlew build test lint\n\n## Failure Policy\n- Any gate failure blocks merge\n- Clear error messages for developers\n- Links to fix instructions","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T22:39:16.765727604Z","created_by":"ubuntu","updated_at":"2026-02-07T23:08:28.445283358Z","closed_at":"2026-02-07T23:08:28.445253342Z","close_reason":"Completed CI workflow scaffold","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-2jn","depends_on_id":"bd-1eo","type":"parent-child","created_at":"2026-02-07T22:39:16.768614485Z","created_by":"ubuntu"}]}
{"id":"bd-2jx","title":"Implement Room database layer (ContentDatabase + UserDatabase)","description":"# Task: Android Database Layer with Room\n\n## What to Build\nRoom database setup mirroring iOS GRDB implementation.\n\n## Two-Database Architecture\n\n### ContentDatabase.kt\n@Database(\n    entities = [PlaceEntity::class, PriceCardEntity::class, PhraseEntity::class, ...],\n    version = 1,\n    exportSchema = true\n)\nabstract class ContentDatabase : RoomDatabase() {\n    abstract fun placeDao(): PlaceDao\n    abstract fun priceCardDao(): PriceCardDao\n    abstract fun phraseDao(): PhraseDao\n    // ... other DAOs\n}\n\n### UserDatabase.kt\n@Database(\n    entities = [UserSettingEntity::class, FavoriteEntity::class, RecentEntity::class],\n    version = 1,\n    exportSchema = true\n)\nabstract class UserDatabase : RoomDatabase() {\n    abstract fun userSettingsDao(): UserSettingsDao\n    abstract fun favoritesDao(): FavoritesDao\n    abstract fun recentsDao(): RecentsDao\n}\n\n### DatabaseManager.kt\n@Singleton\nclass DatabaseManager @Inject constructor(\n    @ApplicationContext private val context: Context\n) {\n    val contentDb: ContentDatabase by lazy { buildContentDatabase() }\n    val userDb: UserDatabase by lazy { buildUserDatabase() }\n    \n    private fun buildContentDatabase(): ContentDatabase {\n        // Copy from assets on first run\n        // Open as read-only\n    }\n    \n    private fun buildUserDatabase(): UserDatabase {\n        // Create in app files directory\n    }\n}\n\n## Entity Examples\n\n### PlaceEntity.kt\n@Entity(tableName = \"places\")\ndata class PlaceEntity(\n    @PrimaryKey val id: String,\n    val name: String,\n    val aliases: String?,  // JSON array\n    val category: String?,\n    val shortDescription: String?,\n    val lat: Double?,\n    val lng: Double?,\n    // ... all fields from schema\n)\n\n## TypeConverters\n\n@TypeConverter\nfun fromStringList(value: List<String>?): String? = \n    value?.let { Json.encodeToString(it) }\n\n@TypeConverter\nfun toStringList(value: String?): List<String>? =\n    value?.let { Json.decodeFromString(it) }\n\n## DAO Examples\n\n@Dao\ninterface PlaceDao {\n    @Query(\"SELECT * FROM places\")\n    fun getAll(): Flow<List<PlaceEntity>>\n    \n    @Query(\"SELECT * FROM places WHERE id = :id\")\n    suspend fun getById(id: String): PlaceEntity?\n    \n    @Query(\"SELECT * FROM places WHERE category = :category\")\n    fun getByCategory(category: String): Flow<List<PlaceEntity>>\n}\n\n## FTS Support\nRoom supports FTS4 out of the box:\n\n@Entity\n@Fts4(contentEntity = PlaceEntity::class)\ndata class PlaceFts(\n    @ColumnInfo(name = \"name\") val name: String,\n    @ColumnInfo(name = \"short_description\") val shortDescription: String\n)\n\n## First-Run Setup\n1. Check if content.db exists in files dir\n2. If not, copy from assets/seed/content.db\n3. Open ContentDatabase read-only\n4. Create UserDatabase if not exists\n\n## Verification\n- Databases initialize without crash\n- Content queries return data\n- User data persists across restarts\n- FTS search works","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T22:29:25.961323823Z","created_by":"ubuntu","updated_at":"2026-02-07T23:26:00.156732194Z","closed_at":"2026-02-07T23:26:00.156635170Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-2jx","depends_on_id":"bd-26j","type":"parent-child","created_at":"2026-02-07T22:29:25.965521137Z","created_by":"ubuntu"},{"issue_id":"bd-2jx","depends_on_id":"bd-2hz","type":"blocks","created_at":"2026-02-07T22:30:29.805056406Z","created_by":"ubuntu"}]}
{"id":"bd-2o0","title":"Create store assets (screenshots, descriptions, metadata)","description":"# Task: Store Assets\n\n## What to Build\nAll assets needed for App Store and Play Store listings.\n\n## Why This Matters\nStore listing is the sales pitch. Users decide to buy in 5 seconds based on:\n- Screenshots showing real value\n- Clear description of what they get\n- Trust signals (no subscriptions, offline)\n\n## App Store Assets (iOS)\n\n### Screenshots (Required: 6.5\" and 5.5\")\n1. **Quote → Action** — showing fairness meter result\n2. **Offline Map** — Medina with user location\n3. **Price Card** — with negotiation scripts\n4. **Home Base Compass** — arrow pointing home\n5. **Phrasebook** — phrase with Arabic/Latin\n6. **Itinerary** — Route Cards in action\n\n### App Preview Video (Optional but Valuable)\n15-30 second video showing:\n- Quote → Action flow\n- Compass to Home Base\n- Offline capability emphasized\n\n### Metadata\n- Title: \"Marrakech Guide - Offline Travel\"\n- Subtitle: \"Prices, Phrases & Navigation\"\n- Keywords: marrakech, morocco, travel, offline, prices, negotiation, guide\n- Description: See copy below\n- Category: Travel\n- Age Rating: 4+\n\n### Description Copy\nFirst paragraph (critical):\n\"The offline Marrakech guide you can trust. Know what things should cost, avoid tourist traps, and navigate with confidence—all without internet.\"\n\nFeatures list:\n• Check any quoted price instantly (Fair? High? Counter-offer?)\n• Offline navigation back to your riad\n• Curated places, not overwhelming lists\n• Darija phrases with Arabic & pronunciation\n• Negotiation scripts that work\n• No subscriptions. No ads. No account required.\n\n## Play Store Assets (Android)\n\n### Screenshots (Phone)\nSame 6 screenshots as iOS, adapted for Android UI.\n\n### Feature Graphic (1024x500)\nMarrakech imagery + app icon + tagline\n\n### Metadata\n- Title: \"Marrakech Guide - Offline Travel\"\n- Short description: \"Prices, phrases & navigation for Marrakech. Works offline.\"\n- Full description: Same as iOS\n- Category: Travel & Local\n- Content rating: Everyone\n\n## Screenshot Guidelines\n\n### Visual Style\n- Use actual app running on device\n- Show realistic Marrakech content\n- Terracotta theme colors\n- No stock photos\n\n### Text Overlays\n- Brief headline per screenshot (2-5 words)\n- \"Know Fair Prices\"\n- \"Navigate Offline\"\n- \"Speak the Language\"\n\n### Device Frames\n- Use Apple/Google approved frames\n- Or borderless (cleaner)\n\n## What's New Text\nTemplate for updates:\n\"• [Feature]: [Brief benefit]\n• [Feature]: [Brief benefit]\n• Bug fixes and improvements\"\n\n## Localization\n- EN default\n- FR versions needed for French market\n- Same screenshots, translated overlays\n\n## Deliverables\n- Screenshot PNGs at required resolutions\n- Video MP4 (if creating)\n- Description copy document\n- Keywords list\n- Localized versions","status":"in_progress","priority":1,"issue_type":"task","created_at":"2026-02-07T22:50:38.015352249Z","created_by":"ubuntu","updated_at":"2026-02-07T23:04:44.251247837Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-2o0","depends_on_id":"bd-1eo","type":"parent-child","created_at":"2026-02-07T22:50:38.017897789Z","created_by":"ubuntu"}]}
{"id":"bd-2ru","title":"Implement RouteEngine with state management","description":"# Task: RouteEngine Implementation\n\n## What to Build\nEngine that manages route execution state and calculates leg information for Route Cards.\n\n## Why Separate Task\nRouteEngine handles:\n- Persistent state across app restarts\n- Step completion/skip logic\n- Current leg calculations (distance, bearing, ETA)\n- Route from both Itineraries and My Day plans\n\n## Interface\n\n### State Management\nstruct RouteProgress {\n    routeId: String               // itinerary ID or plan ID\n    routeType: RouteType          // .itinerary or .myDayPlan\n    currentStepIndex: Int\n    stepsCompleted: [Int]\n    stepsSkipped: [Int]\n    startedAt: Date\n    pausedAt: Date?\n}\n\n### Leg Information\nstruct RouteLeg {\n    fromPlace: Place?             // nil if first step\n    toPlace: Place\n    distanceMeters: Double\n    bearingDegrees: Double\n    estimatedWalkMinutes: Int\n    routeHint: String?            // e.g., \"Exit palace, turn left\"\n    isLastStep: Bool\n}\n\n### Protocol\nprotocol RouteEngine {\n    // Start routes\n    func startRoute(itinerary: Itinerary) -> RouteProgress\n    func startRoute(plan: Plan) -> RouteProgress\n    \n    // Get current state\n    func getCurrentLeg(progress: RouteProgress, currentLocation: Coordinate?) -> RouteLeg\n    \n    // Mutations\n    func completeCurrentStep(progress: inout RouteProgress)\n    func skipCurrentStep(progress: inout RouteProgress)\n    func pauseRoute(progress: inout RouteProgress)\n    func resumeRoute(progress: inout RouteProgress)\n    func exitRoute(progress: inout RouteProgress)\n    \n    // Queries\n    func isRouteComplete(progress: RouteProgress) -> Bool\n    func getCompletionPercentage(progress: RouteProgress) -> Double\n    func getTimeElapsed(progress: RouteProgress) -> TimeInterval\n}\n\n## State Persistence\nRouteProgress stored in user.db:\n- Table: active_route\n- Only one active route at a time\n- Survives app termination and restart\n- Cleared when route completed or exited\n\n## Leg Calculations\n\n### Distance and Bearing\nUses GeoEngine:\n- If current location available: distance from user to next stop\n- If not: distance from previous stop to next stop\n- Bearing for compass arrow\n\n### Walk Time Estimate\nestimatedMinutes = distanceMeters / walkingSpeed\nwalkingSpeed:\n- Default: 75 m/min (4.5 km/h)\n- Medina: 50 m/min (3 km/h) — denser, more stops\n\n### Route Hints\nFrom itinerary step data or generated:\n- \"Head toward the minaret\"\n- \"Look for blue tiles on your left\"\n\n## Edge Cases\n\n### Empty Itinerary\n- Refuse to start, show error\n\n### All Steps Skipped\n- Mark route as complete\n- Show \"Route finished (all skipped)\"\n\n### Location Unavailable\n- Use previous stop as \"from\" point\n- Show distance between stops instead of from user\n\n### Mid-Route App Kill\n- State persisted, resume on next open\n- Show \"Resume route?\" prompt on Home screen\n\n## Test Cases\n\n### Case 1: Normal Progression\n- Start 5-step route\n- Complete steps 0, 1, 2\n- Assert: currentStepIndex = 3, stepsCompleted = [0,1,2]\n\n### Case 2: Skip Step\n- Skip step 2\n- Assert: step 2 in stepsSkipped, advanced to step 3\n\n### Case 3: Persistence\n- Start route, complete 2 steps\n- Simulate app restart (reload from DB)\n- Assert: state restored correctly\n\n### Case 4: Completion\n- Complete all steps\n- Assert: isRouteComplete = true","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T22:48:20.028596250Z","created_by":"ubuntu","updated_at":"2026-02-07T22:50:49.506789472Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-2ru","depends_on_id":"bd-1iv","type":"blocks","created_at":"2026-02-07T22:50:49.506768361Z","created_by":"ubuntu"},{"issue_id":"bd-2ru","depends_on_id":"bd-2bl","type":"parent-child","created_at":"2026-02-07T22:48:20.032070250Z","created_by":"ubuntu"}]}
{"id":"bd-2sa","title":"Implement standard screen state components (loading, error, offline)","description":"# Task: Standard Screen State Components (Android)\n\n## What to Build\nAndroid/Compose implementation of the standard screen states.\nSee iOS task bd-1v5 for full specification.\n\n## Components (Compose)\n\n### LoadingContent\n@Composable\nfun LoadingContent(\n    modifier: Modifier = Modifier,\n    skeleton: @Composable () -> Unit\n)\n\n### OfflineBanner\n@Composable\nfun OfflineBanner(\n    onDismiss: () -> Unit,\n    modifier: Modifier = Modifier\n)\n\n### ErrorContent\n@Composable\nfun ErrorContent(\n    message: String,\n    onRetry: (() -> Unit)?,\n    alternativeActions: List<ErrorAction> = emptyList(),\n    modifier: Modifier = Modifier\n)\n\n### PullToRefresh\nUsing Accompanist or Material3 pull-to-refresh\n\n## State Container\nsealed class ScreenState<out T> {\n    object Loading : ScreenState<Nothing>()\n    data class Content<T>(val data: T) : ScreenState<T>()\n    data class Refreshing<T>(val data: T) : ScreenState<T>()\n    data class Offline<T>(val cachedData: T?) : ScreenState<T>()\n    data class Error(val error: Throwable) : ScreenState<Nothing>()\n}\n\n## Usage in ViewModel\nclass PlacesViewModel : ViewModel() {\n    private val _state = MutableStateFlow<ScreenState<List<Place>>>(ScreenState.Loading)\n    val state: StateFlow<ScreenState<List<Place>>> = _state.asStateFlow()\n    \n    fun load() {\n        viewModelScope.launch {\n            _state.value = ScreenState.Loading\n            try {\n                val places = repository.getPlaces()\n                _state.value = ScreenState.Content(places)\n            } catch (e: Exception) {\n                _state.value = ScreenState.Error(e)\n            }\n        }\n    }\n}\n\n## Skeleton Components\nMatch iOS skeletons:\n- ListItemSkeleton\n- CardSkeleton\n- DetailSkeleton\n- ShimmerEffect modifier\n\n## Parity with iOS\nMust match iOS behavior exactly:\n- Same states, same transitions\n- Same visual patterns\n- Same accessibility announcements","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T22:50:13.998817201Z","created_by":"ubuntu","updated_at":"2026-02-08T21:33:20.421214318Z","closed_at":"2026-02-08T21:33:20.421167858Z","close_reason":"Completed","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-2sa","depends_on_id":"bd-26j","type":"parent-child","created_at":"2026-02-07T22:50:14.001464403Z","created_by":"ubuntu"}]}
{"id":"bd-2so","title":"Implement PlanEngine with test cases","description":"# Task: PlanEngine Implementation\n\n## What to Build\nThe algorithm that generates \"My Day\" plans from user constraints.\n\n## Why Separate Task\nUnlike PricingEngine (deterministic math), PlanEngine involves:\n- Optimization (minimize travel time)\n- Constraint satisfaction (time budget, opening hours)\n- Scoring (interest matching, variety)\n- Some controlled randomness\n\nNeeds careful implementation and testing.\n\n## Interface\n\n### Inputs\nstruct PlanInput {\n    availableMinutes: Int          // 120-600\n    startPoint: Coordinate?        // nil = no preference\n    interests: [Interest]          // history, food, shopping, etc.\n    pace: Pace                     // relaxed, standard, active\n    budgetTier: BudgetTier         // budget, mid, splurge\n    currentTime: Date              // for \"open now\" filtering\n}\n\n### Outputs\nstruct PlanOutput {\n    stops: [PlanStop]              // ordered list\n    totalMinutes: Int              // actual time including travel\n    estimatedCostRange: PriceRange // sum of stop costs\n    warnings: [String]             // e.g., \"Some places may be closed\"\n}\n\nstruct PlanStop {\n    placeId: String\n    arrivalTime: Date\n    departureTime: Date\n    travelMinutesFromPrevious: Int\n    visitMinutes: Int\n}\n\n## Algorithm\n\n### 1. Filter Available Places\n- Matches at least one interest\n- Within budget tier\n- Will be open during potential visit window\n- Not recently visited (from recents)\n\n### 2. Score Places\nFor each candidate, compute score:\nscore = interestMatchCount * 10\n      + touristTrapPenalty       // -5 for \"tourist-heavy\"\n      + varietyBonus             // +3 if different category from already selected\n      + timeOfDayBonus           // +5 if bestTimeWindows matches\n\n### 3. Greedy Selection with Time Budget\nwhile (remainingMinutes > minStopTime):\n    candidates = places that fit in remaining time\n    select highest scored candidate\n    add to plan\n    subtract visitTime + travelTimeToNext\n    \n### 4. Optimize Order\nOnce stops selected:\n- Compute travel time between all pairs (GeoEngine)\n- Reorder to minimize total travel time\n- Respect \"best time\" constraints where possible\n\n### 5. Handle Meals\nif (time spans 12:00-14:00): ensure one restaurant stop\nif (time spans 19:00-21:00): ensure one restaurant stop\n\n### 6. Calculate Timing\nStarting from currentTime or reasonable default (9:00 AM):\n- Assign arrival/departure times\n- Include travel time between stops\n\n## Test Cases\n\n### Case 1: Short History Day\nInput: 180 min, interests: [history], pace: standard\nAssert: 2-3 stops, all museums/landmarks, total ≤ 180 min\n\n### Case 2: Full Food Day\nInput: 480 min, interests: [food], pace: relaxed\nAssert: includes breakfast, lunch, dinner stops\n\n### Case 3: Impossible Constraints\nInput: 60 min, interests: [gardens] (only Majorelle, which takes 90min)\nAssert: returns warning, suggests alternatives or shorter stop\n\n### Case 4: Opening Hours Respect\nInput: starts at 5 PM, 180 min\nAssert: excludes places that close at 5 PM\n\n## Determinism vs Variety\n- Same inputs on same day should produce similar plans\n- Use date as seed for controlled randomness\n- Different days can produce different plans\n- User can \"shuffle\" to get alternatives\n\n## Platform Parity\nBoth iOS and Android should produce plans that:\n- Respect same constraints\n- Use same scoring logic\n- May differ in tie-breaking (acceptable)","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-07T22:47:55.173497372Z","created_by":"ubuntu","updated_at":"2026-02-07T22:50:49.467195371Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-2so","depends_on_id":"bd-1ls","type":"parent-child","created_at":"2026-02-07T22:47:55.176192165Z","created_by":"ubuntu"},{"issue_id":"bd-2so","depends_on_id":"bd-20q","type":"blocks","created_at":"2026-02-07T22:50:49.467171856Z","created_by":"ubuntu"}]}
{"id":"bd-2z1","title":"Localization — EN/FR UI with Locale-Aware Formatting","description":"# Feature: Localization\n\n## Purpose\nSupport English and French UI while keeping content in English for v1.\n\n## Why This Matters\n- French-speaking tourists are a major audience (Morocco's second language)\n- Locale-aware formatting builds trust\n- Foundation for future content localization\n\n## Scope for v1\n\n### Localized UI (EN + FR)\n- All button labels\n- Navigation items\n- Error messages\n- System messages\n- Settings labels\n- Onboarding text\n\n### Content Stays English\n- Places descriptions\n- Price card text\n- Tips and culture articles\n- Phrasebook (multi-language by design)\n\n### Rationale\n- Content localization is expensive and time-consuming\n- UI localization is straightforward\n- French visitors comfortable with English content\n- Can add French content in v1.x update\n\n## Implementation\n\n### iOS\n- String Catalogs (Localizable.xcstrings)\n- Use LocalizedStringKey for all UI text\n- Environment locale for formatting\n\nString format:\nText(\"explore.title\", comment: \"Explore tab title\")\nText(\"price.range\", values: [min, max], comment: \"Price range\")\n\n### Android\n- strings.xml in values/ and values-fr/\n- Use stringResource(R.string.xxx)\n- Compose LocalConfiguration for locale\n\n## Locale-Aware Formatting\n\n### Dates\n- iOS: Date.formatted() with locale\n- Android: DateTimeFormatter with locale\n- Examples: \"Feb 15, 2026\" vs \"15 févr. 2026\"\n\n### Numbers\n- iOS: NumberFormatter with locale\n- Android: NumberFormat with locale\n- Thousands separator: \"1,000\" vs \"1 000\"\n\n### Currency\n- MAD always shown as \"MAD\" (not localized)\n- Home currency: uses locale format\n- Conversion: respects decimal separators\n\n### Distance\n- Metric everywhere (km, m)\n- No imperial conversion needed for Marrakech\n\n## String Management\n\n### Key Naming Convention\nfeature.screen.element.state\n\nExamples:\n- home.quickAction.quoteCheck.title\n- prices.detail.lastReviewed.label\n- error.offline.message\n\n### Pluralization\niOS: String Catalog handles plurals\nAndroid: plurals resource\n\n### Variables\niOS: String interpolation in LocalizedStringKey\nAndroid: String format arguments\n\n## Fallback Behavior\n- If French translation missing: show English\n- Never show blank or key name\n- Log missing translations (dev only)\n\n## Testing\n- Run app in French language\n- Verify all UI strings localized\n- Check formatting (dates, numbers)\n- Verify no truncation issues\n- Test RTL layout not broken\n\n## Files\niOS:\n- Localizable.xcstrings (contains EN + FR)\n\nAndroid:\n- res/values/strings.xml (EN)\n- res/values-fr/strings.xml (FR)","status":"open","priority":1,"issue_type":"feature","created_at":"2026-02-07T22:38:12.463740308Z","created_by":"ubuntu","updated_at":"2026-02-07T22:38:12.467024263Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-2z1","depends_on_id":"bd-1eo","type":"parent-child","created_at":"2026-02-07T22:38:12.466988490Z","created_by":"ubuntu"}]}
{"id":"bd-316","title":"Set up Android Gradle project with Kotlin/Compose","description":"# Task: Android Gradle Project Setup\n\n## What to Build\nCreate the Android project with proper configuration and dependencies.\n\n## Project Configuration\n- Application ID: com.marrakechguide\n- Min SDK: 26 (Android 8.0)\n- Target SDK: Latest required by Play Store\n- Kotlin: 1.9+\n- Compose BOM: Latest stable\n\n## Project Structure\nandroid/\n├── app/\n│   ├── build.gradle.kts\n│   └── src/\n│       ├── main/\n│       │   ├── AndroidManifest.xml\n│       │   ├── kotlin/com/marrakechguide/\n│       │   │   ├── MarrakechGuideApp.kt  # Application class\n│       │   │   ├── MainActivity.kt\n│       │   │   ├── core/\n│       │   │   │   ├── database/\n│       │   │   │   ├── repository/\n│       │   │   │   ├── service/\n│       │   │   │   └── engine/\n│       │   │   ├── feature/\n│       │   │   │   ├── home/\n│       │   │   │   ├── explore/\n│       │   │   │   ├── eat/\n│       │   │   │   ├── prices/\n│       │   │   │   ├── quoteaction/\n│       │   │   │   ├── homebase/\n│       │   │   │   ├── myday/\n│       │   │   │   ├── routecards/\n│       │   │   │   ├── phrasebook/\n│       │   │   │   ├── search/\n│       │   │   │   ├── more/\n│       │   │   │   └── settings/\n│       │   │   ├── ui/\n│       │   │   │   ├── components/\n│       │   │   │   ├── theme/\n│       │   │   │   └── navigation/\n│       │   │   └── di/\n│       │   ├── res/\n│       │   │   ├── values/\n│       │   │   └── values-fr/\n│       │   └── assets/\n│       │       └── seed/\n│       │           └── content.db\n│       ├── test/\n│       └── androidTest/\n├── build.gradle.kts\n├── settings.gradle.kts\n└── gradle.properties\n\n## Dependencies (build.gradle.kts)\n// Compose BOM\nimplementation(platform(\"androidx.compose:compose-bom:2024.xx.xx\"))\nimplementation(\"androidx.compose.material3:material3\")\nimplementation(\"androidx.compose.ui:ui\")\nimplementation(\"androidx.compose.ui:ui-tooling-preview\")\n\n// Navigation\nimplementation(\"androidx.navigation:navigation-compose:2.7.x\")\n\n// Room\nimplementation(\"androidx.room:room-runtime:2.6.x\")\nimplementation(\"androidx.room:room-ktx:2.6.x\")\nksp(\"androidx.room:room-compiler:2.6.x\")\n\n// Hilt\nimplementation(\"com.google.dagger:hilt-android:2.48.x\")\nksp(\"com.google.dagger:hilt-compiler:2.48.x\")\n\n// Coroutines\nimplementation(\"org.jetbrains.kotlinx:kotlinx-coroutines-android:1.7.x\")\n\n## Manifest Permissions\n<uses-permission android:name=\"android.permission.ACCESS_FINE_LOCATION\" />\n<uses-permission android:name=\"android.permission.ACCESS_COARSE_LOCATION\" />\n<uses-permission android:name=\"android.permission.INTERNET\" />\n\nNote: Location permissions only requested when needed.\n\n## Verification\n- Project syncs without Gradle errors\n- Builds debug APK successfully\n- Runs on API 26+ emulator\n- Shows basic Compose UI","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T22:28:42.314507616Z","created_by":"ubuntu","updated_at":"2026-02-07T23:08:59.188195577Z","closed_at":"2026-02-07T23:08:59.188149808Z","close_reason":"Completed Android Gradle+Compose scaffold; gradle tasks verified. compileDebugKotlin blocked in this environment due missing Android SDK configuration.","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-316","depends_on_id":"bd-26j","type":"parent-child","created_at":"2026-02-07T22:28:42.319452991Z","created_by":"ubuntu"}]}
{"id":"bd-34f","title":"Phase 1: Core Features — The Heart of the Product","description":"# Epic: Core Features\n\n## Purpose\nBuild the features that deliver the core value proposition: helping tourists navigate Marrakech with confidence about prices, culture, and language. This phase produces the \"minimum lovable product.\"\n\n## Why This Phase Matters\nThis is where the app earns its price. The Quote → Action feature alone can save tourists from overpaying dozens of times. The Phrasebook reduces anxiety. The Explore/Eat features give curated, trustworthy recommendations instead of overwhelming TripAdvisor noise.\n\n## What Gets Built\n\n### 1. Content Display Features\n- **Explore**: Browse curated places with filters, map/list toggle, detail views\n- **Eat**: Curated restaurants with tags (budget, rooftop, family-friendly)\n- **Prices**: Price card categories and detailed pricing info with negotiation scripts\n- **Phrasebook**: Darija glossary with Arabic/Latin/English, RTL support, search\n- **Itineraries**: Pre-built day plans users can follow\n- **Tips & Culture**: Practical safety tips, etiquette guides, scam awareness\n\n### 2. The Killer Feature: Quote → Action\nThe instant price fairness check that justifies the app purchase:\n- User selects category (taxi, hammam, souk item, etc.)\n- User enters quoted price in MAD\n- App shows fairness meter (Low / Fair / High / Very High)\n- App provides adjusted range with context modifiers (night, peak season)\n- App gives counter-offer suggestions and negotiation scripts\n- Everything works offline, deterministically\n\n### 3. Search\nGlobal full-text search across all content types (places, prices, phrases, tips).\nMust be fast (<100ms), work offline, and handle Arabic/Latin normalization.\n\n### 4. User State\n- Favorites (save items for later)\n- Recently viewed (quick access to what user looked at)\n- Both stored in user.db, synced never (privacy-first)\n\n## Technical Components\n\n### Repositories (Data Access Layer)\nEach content type gets a repository with standard CRUD + specialized queries:\n- PlaceRepository, PriceCardRepository, PhraseRepository\n- ItineraryRepository, TipRepository, CultureRepository\n- FavoritesRepository, RecentsRepository\n\n### Engines (Business Logic)\n- **PricingEngine**: The Quote → Action brain. Inputs: priceCard, quotedMAD, modifiers. Outputs: fairnessLevel, adjustedRange, counterOffer, scripts.\n\n### Search Service\n- FTS5 (iOS) / FTS4 (Android) integration\n- Normalization for Arabic/Latin text\n- Ranking: exact > alias > prefix > contains\n\n## Success Criteria\n- User can browse all content types with filters\n- User can search and find relevant results in <100ms\n- Quote → Action returns correct fairness assessment for test vectors\n- User can save favorites and see recents\n- All features work in airplane mode\n- iOS and Android show identical content and behavior\n\n## Platform Parity\nCritical that both platforms implement the same:\n- PricingEngine logic (test with shared vectors)\n- Search normalization\n- UI flows and information architecture\n\n## Dependencies\n- Requires: Phase 0 Foundation (content pipeline, DB setup, app shells)\n- Blocks: Phase 2 Location Features (needs places for Go Home destinations)\n- Blocks: Phase 3 Polish (needs features to polish)","status":"open","priority":0,"issue_type":"epic","created_at":"2026-02-07T22:23:13.865889381Z","created_by":"ubuntu","updated_at":"2026-02-07T22:39:27.001778742Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-34f","depends_on_id":"bd-3lc","type":"blocks","created_at":"2026-02-07T22:39:27.001754986Z","created_by":"ubuntu"}]}
{"id":"bd-37x","title":"Phase 2: Location Features — Confidence in the Moment","description":"# Epic: Location Features\n\n## Purpose\nBuild the location-aware features that provide confidence \"in the moment\" — when the tourist is actually out in Marrakech, potentially lost, potentially being quoted a price, and needs immediate help.\n\n## Why This Phase Matters\nThese features are the \"confidence companion\" promise made real:\n- **Home Base Compass**: \"I'm lost in the Medina but I can always find my way back\"\n- **My Day Planner**: \"I don't have to plan — the app gives me a realistic day\"\n- **Route Cards**: \"I can follow itineraries step-by-step without getting lost\"\n\nThese are high-perceived-value features that differentiate from generic travel guides.\n\n## What Gets Built\n\n### 1. Location Services\nFoundation for all location-aware features:\n- **iOS**: CoreLocation wrapper with proper lifecycle management\n- **Android**: FusedLocationProviderClient wrapper\n- **Both**: Request only when needed, stop when screen closes, respect battery\n\n### 2. Heading Services\nFor compass arrow direction:\n- **iOS**: CLLocationManager heading updates\n- **Android**: SensorManager with TYPE_ROTATION_VECTOR\n- **Both**: Throttle UI updates to 10-20Hz, surface accuracy/confidence\n\n### 3. GeoEngine\nPure utility functions (no platform dependencies):\n- haversine(point1, point2) → distance in meters\n- bearing(from, to) → degrees\n- relativeAngle(bearing, heading) → arrow rotation\n- Shared test vectors to ensure iOS/Android produce identical results\n\n### 4. Home Base Compass\nThe \"Go Home\" feature:\n- User sets their riad/hotel once (HomeBaseSetup)\n- GoHomeView shows compass arrow pointing home + distance\n- Large-text taxi driver card (Arabic + Latin address)\n- Works fully offline\n- Manual refresh button\n- Heading confidence indicator (good/weak/unavailable)\n\n### 5. My Day Planner (PlanEngine)\nOffline daily plan builder:\n- User picks constraints: time (2-10h), pace, budget tier, interests\n- PlanEngine generates 3-7 stop itinerary\n- Avoids closed places (when structured hours available)\n- Prefers geographically coherent routes (minimize backtracking)\n- Output feeds into Route Cards\n\n### 6. Route Cards (RouteEngine)\nStep-by-step guidance for following itineraries:\n- Route overview (all stops, total time estimate)\n- Next stop view (name, distance, bearing, walk time estimate)\n- Compass arrow to destination\n- Mark as done → advance to next\n- Progress persisted across app restarts\n- Medina Mode fallback (simplified guidance when GPS unreliable)\n\n## Privacy Guarantees\n- Location is foreground-only (never background in v1)\n- Used only on-device while compass/route screens are open\n- No backend receives location data\n- Denial of permission keeps app fully usable (just without these features)\n\n## Battery Considerations\n- Start with balanced accuracy, escalate only on explicit refresh\n- Automatic timeout if screen left active too long\n- Stop updates immediately when screen closes\n- Throttle UI updates regardless of sensor frequency\n\n## Technical Components\n\n### Services\n- LocationService (iOS: CoreLocation, Android: FusedLocation)\n- HeadingService (iOS: CLLocationManager, Android: SensorManager)\n\n### Engines\n- GeoEngine (cross-platform math utilities)\n- PlanEngine (My Day generation logic)\n- RouteEngine (route progress + leg calculations)\n\n### Views/Screens\n- HomeBaseSetupView, GoHomeView, CompassArrowView\n- MyDayView, ConstraintPickerView\n- RouteOverviewView, NextStopView\n\n## Success Criteria\n- Compass accurately points to Home Base location\n- My Day generates sensible plans for given constraints\n- Route Cards guide user through itinerary reliably\n- Battery drain is reasonable during extended use\n- All features work offline\n- Permission denial gracefully degrades (app still usable)\n- iOS and Android produce identical GeoEngine outputs\n\n## Dependencies\n- Requires: Phase 0 Foundation (app shells, DB)\n- Requires: Phase 1 Core (places for destinations, itineraries for routes)\n- Blocks: None (but enhances overall product value)","status":"open","priority":0,"issue_type":"epic","created_at":"2026-02-07T22:23:42.575826952Z","created_by":"ubuntu","updated_at":"2026-02-07T22:39:27.082686520Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-37x","depends_on_id":"bd-34f","type":"blocks","created_at":"2026-02-07T22:39:27.082671818Z","created_by":"ubuntu"}]}
{"id":"bd-3cb","title":"Create shared engine test vectors (Pricing, Geo, Plan)","description":"# Task: Shared Engine Test Vectors\n\n## What to Build\nJSON test vector files that both iOS and Android test suites consume to verify engine implementations produce identical results.\n\n## Why This Matters\nThe app's core value depends on consistent behavior:\n- PricingEngine: Quote → Action fairness must be identical\n- GeoEngine: Distance/bearing calculations must match\n- Both platforms showing different results = broken trust\n\n## Files to Create\n\n### shared/tests/pricing-engine-vectors.json\nTest cases for PricingEngine:\n[\n  {\n    \"name\": \"Basic fair price\",\n    \"input\": {\n      \"expectedMin\": 20, \"expectedMax\": 40,\n      \"quotedMAD\": 30,\n      \"modifiers\": [],\n      \"quantity\": 1,\n      \"highMultiplier\": 1.25,\n      \"lowMultiplier\": 0.75\n    },\n    \"expected\": {\n      \"fairness\": \"fair\",\n      \"adjustedMin\": 20,\n      \"adjustedMax\": 40\n    }\n  },\n  // 15-20 more cases covering:\n  // - Low price (suspicious)\n  // - High price\n  // - Very high price\n  // - With night modifier\n  // - With multiple modifiers\n  // - With quantity > 1\n  // - Edge cases (exactly on boundary)\n]\n\n### shared/tests/geo-engine-vectors.json\nTest cases for GeoEngine:\n[\n  {\n    \"name\": \"Haversine distance - Marrakech\",\n    \"function\": \"haversine\",\n    \"input\": {\n      \"from\": { \"lat\": 31.6258, \"lng\": -7.9891 },\n      \"to\": { \"lat\": 31.6219, \"lng\": -7.9833 }\n    },\n    \"expected\": {\n      \"meters\": 750,\n      \"tolerance\": 10\n    }\n  },\n  {\n    \"name\": \"Bearing north\",\n    \"function\": \"bearing\",\n    \"input\": {\n      \"from\": { \"lat\": 31.0, \"lng\": -8.0 },\n      \"to\": { \"lat\": 32.0, \"lng\": -8.0 }\n    },\n    \"expected\": {\n      \"degrees\": 0,\n      \"tolerance\": 0.1\n    }\n  },\n  // More cases for bearing, relativeAngle, formatDistance\n]\n\n### shared/tests/plan-engine-vectors.json (Optional)\nMore complex, may allow some variation:\n[\n  {\n    \"name\": \"Short history day\",\n    \"input\": {\n      \"availableMinutes\": 240,\n      \"interests\": [\"history\"],\n      \"pace\": \"standard\"\n    },\n    \"assertions\": {\n      \"minStops\": 2,\n      \"maxStops\": 4,\n      \"totalMinutesMax\": 240,\n      \"containsCategory\": [\"museum\", \"landmark\"]\n    }\n  }\n]\n\n## Integration\n\n### iOS Tests (XCTest)\nfunc testPricingEngine() {\n    let vectors = loadVectors(\"pricing-engine-vectors.json\")\n    for vector in vectors {\n        let result = PricingEngine.evaluate(vector.input)\n        XCTAssertEqual(result.fairness, vector.expected.fairness)\n        // ... more assertions\n    }\n}\n\n### Android Tests (JUnit)\n@Test\nfun testPricingEngine() {\n    val vectors = loadVectors(\"pricing-engine-vectors.json\")\n    vectors.forEach { vector ->\n        val result = PricingEngine.evaluate(vector.input)\n        assertEquals(vector.expected.fairness, result.fairness)\n    }\n}\n\n## CI Integration\n- Tests run on every PR\n- Failure blocks merge\n- Both platforms must pass same vectors","status":"in_progress","priority":0,"issue_type":"task","created_at":"2026-02-07T22:38:59.059049457Z","created_by":"ubuntu","updated_at":"2026-02-08T11:54:34.087086584Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-3cb","depends_on_id":"bd-34f","type":"parent-child","created_at":"2026-02-07T22:38:59.063031367Z","created_by":"ubuntu"}]}
{"id":"bd-3el","title":"Phrasebook Feature — Darija Survival Glossary","description":"# Feature: Phrasebook\n\n## Purpose\nProvide tourists with essential Darija phrases for common situations, with Arabic script, Latin transliteration, and English meaning.\n\n## Why It Matters\nLanguage friction is a major source of tourist anxiety. Having phrases ready:\n- Builds confidence in interactions\n- Shows respect for local culture\n- Helps in practical situations (taxi, bargaining, emergencies)\n\n## Screens\n\n### PhrasebookView/Screen (Categories)\n- Search bar at top\n- Category list:\n  - Greetings & Basics\n  - Numbers (1-100, bargaining essentials)\n  - Bargaining & Shopping\n  - Taxi & Directions\n  - Food & Restaurants\n  - Emergencies\n- Each category shows phrase count\n- Recent phrases section (if any viewed)\n\n### PhraseCategoryView\n- List of phrases in category\n- Each shows: Latin, Arabic (smaller), English\n- Tap for detail\n- Search within category\n\n### PhraseDetailView/Screen\n- Latin transliteration (large, easy to read)\n- Arabic script (proper RTL rendering)\n- English meaning\n- Audio playback button (if audio available)\n- \"Show to Driver\" button → opens large text mode\n- Copy buttons for each version\n- Related situations (when to use)\n- Save/favorite toggle\n\n### LargeTextMode (Taxi Driver Card)\n- Full-screen display\n- Arabic text very large\n- Latin below\n- High contrast\n- Screen stays on\n- Easy back gesture\n\n## Technical Requirements\n\n### RTL Text Rendering\n- Arabic text must render correctly right-to-left\n- Proper Arabic shaping and ligatures\n- Numbers in Arabic (Eastern Arabic numerals) or Western as appropriate\n- Mixed RTL/LTR layout handled correctly\n\n### Search\n- FTS on latin + english text\n- Arabic search is complex (defer to v2)\n- Fast results (<100ms)\n- Highlight matches\n\n### Audio (Optional)\n- MP3/AAC files bundled or downloaded\n- Simple playback controls\n- Works offline\n- Audio Pack download for full set\n\n## Data Model\nGlossaryPhrase:\n- id: String\n- category: String\n- arabic: String (RTL)\n- latin: String\n- english: String\n- audio: String? (asset path or URL)\n- usedIn: [String]? (related situations)\n\n## Accessibility\n- Arabic text properly tagged for screen readers\n- Audio descriptions\n- Touch targets for all interactive elements\n- Focus order: latin → arabic → english → actions\n\n## Offline\n100% offline. All phrases from content.db.\nAudio from bundled assets or downloaded pack.","status":"open","priority":1,"issue_type":"feature","created_at":"2026-02-07T22:33:42.662526852Z","created_by":"ubuntu","updated_at":"2026-02-07T22:39:34.063936673Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-3el","depends_on_id":"bd-34f","type":"parent-child","created_at":"2026-02-07T22:33:42.664615118Z","created_by":"ubuntu"},{"issue_id":"bd-3el","depends_on_id":"bd-3j8","type":"blocks","created_at":"2026-02-07T22:39:34.063904495Z","created_by":"ubuntu"}]}
{"id":"bd-3fn","title":"Implement Material 3 theme with Marrakech palette","description":"# Task: Android Theme System\n\n## What to Build\nMaterial 3 theme with Marrakech terracotta identity, matching iOS.\n\n## Color Scheme\n\n### Marrakech Palette (matching iOS)\nval Terracotta50 = Color(0xFFFDF5F2)\nval Terracotta100 = Color(0xFFFAE6DE)\nval Terracotta200 = Color(0xFFF5C9B8)\nval Terracotta300 = Color(0xFFED9F7F)\nval Terracotta400 = Color(0xFFE57A4F)\nval Terracotta500 = Color(0xFFD4572B)  // Primary\nval Terracotta600 = Color(0xFFB84421)\nval Terracotta700 = Color(0xFF8F341A)\nval Terracotta800 = Color(0xFF6A2714)\nval Terracotta900 = Color(0xFF4A1C0F)\n\n### Material 3 ColorScheme\nprivate val LightColorScheme = lightColorScheme(\n    primary = Terracotta500,\n    onPrimary = Color.White,\n    primaryContainer = Terracotta100,\n    onPrimaryContainer = Terracotta900,\n    secondary = Terracotta600,\n    // ... complete scheme\n    surface = Color.White,\n    onSurface = Neutral900,\n    background = Neutral50,\n)\n\nprivate val DarkColorScheme = darkColorScheme(\n    primary = Terracotta300,\n    onPrimary = Terracotta900,\n    primaryContainer = Terracotta800,\n    onPrimaryContainer = Terracotta100,\n    // ... complete scheme with warm dark colors\n)\n\n## Typography\n\n### Type.kt\nval Typography = Typography(\n    displayLarge = TextStyle(\n        fontFamily = FontFamily.Default,\n        fontWeight = FontWeight.Normal,\n        fontSize = 57.sp,\n        lineHeight = 64.sp,\n    ),\n    // ... all Material typography roles\n    bodyLarge = TextStyle(\n        fontFamily = FontFamily.Default,\n        fontWeight = FontWeight.Normal,\n        fontSize = 16.sp,\n        lineHeight = 24.sp,\n    ),\n)\n\n## Theme Composable\n\n### Theme.kt\n@Composable\nfun MarrakechGuideTheme(\n    darkTheme: Boolean = isSystemInDarkTheme(),\n    content: @Composable () -> Unit\n) {\n    val colorScheme = if (darkTheme) DarkColorScheme else LightColorScheme\n    \n    MaterialTheme(\n        colorScheme = colorScheme,\n        typography = Typography,\n        content = content\n    )\n}\n\n## Shape\nval Shapes = Shapes(\n    small = RoundedCornerShape(4.dp),\n    medium = RoundedCornerShape(8.dp),\n    large = RoundedCornerShape(12.dp),\n)\n\n## Semantic Colors\nobject FairnessColors {\n    val Low = Color(0xFFEAB308)     // Warning/suspicious\n    val Fair = Color(0xFF22C55E)    // Good\n    val High = Terracotta400        // Slightly high\n    val VeryHigh = Color(0xFFEF4444) // Alert\n}\n\n## Dark Mode\n- Use warm terracotta tones for dark theme\n- Avoid cold blue/purple darkness\n- Maintain brand identity in both modes\n\n## Verification\n- Light theme renders correctly\n- Dark theme renders correctly\n- Typography scales properly\n- Colors match iOS counterparts\n- System theme changes work","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T22:30:00.753175826Z","created_by":"ubuntu","updated_at":"2026-02-07T23:10:33.958238126Z","closed_at":"2026-02-07T23:10:33.958192538Z","close_reason":"Implemented as part of bd-1qz. Android theme now has full Material 3 color scheme with Marrakech terracotta palette, light/dark mode support, spacing and corner radius tokens.","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-3fn","depends_on_id":"bd-26j","type":"parent-child","created_at":"2026-02-07T22:30:00.757450837Z","created_by":"ubuntu"}]}
{"id":"bd-3j8","title":"Repository Layer — Data Access Abstraction","description":"# Feature: Repository Layer\n\n## Purpose\nCreate the data access layer that abstracts database queries behind clean interfaces. Repositories provide all data to ViewModels, hiding the complexity of SQLite/Room/GRDB.\n\n## Why Repositories Matter\n- ViewModels don't care about SQL\n- Database implementation can change without affecting features\n- Testable with mock repositories\n- Consistent patterns across all content types\n\n## Repositories to Build\n\n### ContentRepositories (read from content.db)\n- PlaceRepository: Browse places, filter by category, search\n- PriceCardRepository: Get price cards, filter by category\n- PhraseRepository: Get phrases, filter by category, search\n- ItineraryRepository: Get itineraries, get steps\n- TipRepository: Get tips, get related items\n- CultureRepository: Get culture articles\n\n### UserRepositories (read/write user.db)\n- FavoritesRepository: Save, remove, list favorites\n- RecentsRepository: Track recently viewed, get history\n- UserSettingsRepository: Get/set settings (Home Base, exchange rate, etc.)\n- PlanRepository: Save/load generated My Day plans\n\n## Interface Pattern\n\nprotocol PlaceRepository {\n    func getAllPlaces() async throws -> [Place]\n    func getPlace(id: String) async throws -> Place?\n    func getPlaces(category: PlaceCategory) async throws -> [Place]\n    func searchPlaces(query: String) async throws -> [Place]\n    func getRelatedPriceCards(placeId: String) async throws -> [PriceCard]\n}\n\n## iOS Implementation\n- Uses GRDB DatabasePool for reads\n- Returns Swift models (Place, PriceCard, etc.)\n- Handles JSON array decoding from TEXT columns\n- Uses FTS5 for search queries\n\n## Android Implementation\n- Uses Room DAOs\n- Returns Kotlin data classes\n- TypeConverters for JSON arrays\n- Uses FTS4/5 for search queries\n\n## Common Queries\n- Get all items (with optional filters)\n- Get single item by ID\n- Search by text query (FTS)\n- Get related items via content_links table\n\n## Success Criteria\n- All content types accessible via repositories\n- Search returns relevant results\n- User data persists correctly\n- Both platforms have identical repository interfaces","status":"closed","priority":0,"issue_type":"feature","created_at":"2026-02-07T22:30:50.142003598Z","created_by":"ubuntu","updated_at":"2026-02-07T23:34:18.067179455Z","closed_at":"2026-02-07T23:34:18.067081918Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-3j8","depends_on_id":"bd-2jx","type":"blocks","created_at":"2026-02-07T22:39:33.948961169Z","created_by":"ubuntu"},{"issue_id":"bd-3j8","depends_on_id":"bd-34f","type":"parent-child","created_at":"2026-02-07T22:30:50.144554107Z","created_by":"ubuntu"},{"issue_id":"bd-3j8","depends_on_id":"bd-wnm","type":"blocks","created_at":"2026-02-07T22:39:33.904564392Z","created_by":"ubuntu"}]}
{"id":"bd-3lc","title":"Phase 0: Foundation — Shared Content Pipeline & Platform Shells","description":"# Epic: Foundation Layer\n\n## Purpose\nEstablish the foundational infrastructure that ALL subsequent development depends on. This includes the shared content pipeline (JSON → SQLite) and the basic app shells for both iOS and Android platforms.\n\n## Why This Comes First\nEverything in this app depends on content. The Quote → Action feature needs price cards. The Explore feature needs places. The Phrasebook needs glossary phrases. Without a working content pipeline, no feature can be built or tested properly.\n\nSimilarly, without the basic app shells (navigation, database setup, theming), there's nowhere to put the features.\n\n## Key Deliverables\n1. **Shared Content Pipeline** (in shared/)\n   - JSON Schema for all content types (places, price_cards, glossary, etc.)\n   - Validation script that catches schema violations before they reach the app\n   - Build script that transforms JSON → SQLite content.db\n   - Link checker that validates internal references (itinerary steps → places, tips → price_cards)\n   - Seed content for development (minimal but representative)\n\n2. **iOS Foundation** (in ios/)\n   - Xcode project with correct structure\n   - GRDB.swift integration for SQLite\n   - DatabaseManager handling content.db + user.db separation\n   - Basic theme tokens (Marrakech terracotta palette)\n   - Tab navigation shell (5 tabs: Home, Explore, Eat, Prices, More)\n   - Reusable components library started\n\n3. **Android Foundation** (in android/)\n   - Gradle project with Kotlin/Compose\n   - Room integration for SQLite\n   - DatabaseManager mirroring iOS structure\n   - Material 3 theme with Marrakech identity\n   - Bottom navigation matching iOS tabs\n   - Reusable Compose components started\n\n## Success Criteria\n- Running node shared/scripts/validate-content.ts validates all JSON\n- Running node shared/scripts/build-bundle.ts produces content.db\n- iOS app launches with tab navigation and loads content from DB\n- Android app launches with bottom nav and loads content from DB\n- Both apps show identical content (proving the pipeline works)\n\n## Architectural Decisions Locked Here\n- Two-database architecture (content.db read-only swap, user.db read-write)\n- GRDB for iOS (excellent FTS5 support, Swift-native)\n- Room for Android (standard, well-documented, FTS4/5 support)\n- Shared JSON schema as single source of truth\n- Platform-native navigation (not cross-platform abstractions)\n\n## Dependencies\nNone — this is the root of the dependency tree.\n\n## Risks & Mitigations\n- Risk: Schema changes mid-project break existing content\n  - Mitigation: Schema versioning, validate-before-ship gates\n- Risk: iOS/Android DB implementations diverge\n  - Mitigation: Shared test vectors for critical queries","status":"closed","priority":0,"issue_type":"epic","created_at":"2026-02-07T22:22:47.535986449Z","created_by":"ubuntu","updated_at":"2026-02-08T21:36:45.960844661Z","closed_at":"2026-02-08T21:36:45.960797570Z","close_reason":"Phase 0 Foundation complete: Content pipeline (validate, build, check-links), iOS foundation (GRDB, repositories, engines), Android foundation (Room, repositories, engines). Both platforms share test vectors.","compaction_level":0,"original_size":0}
{"id":"bd-3rw","title":"Offline Maps — Medina Navigation Without Internet","description":"# Feature: Offline Maps\n\n## Purpose\nDisplay and navigate maps in the Medina without internet connection. This is CRITICAL for the \"confidence companion\" promise—tourists need to see where they are and where they're going.\n\n## Why This is P0\nWithout offline maps:\n- Users can't see their location in the Medina\n- Route Cards can only show compass direction, not a map\n- \"Navigate\" buttons are useless offline\n- The app fails at the moment of highest need (lost in the Medina, no signal)\n\n## What Gets Built\n\n### 1. Offline Map Renderer\n- Display vector tiles or MBTiles offline\n- Smooth panning and zooming\n- User location dot\n- Place markers with clustering\n\n### 2. Medina Pack Content\n- Map tiles for Medina core (~50MB)\n- Walking graph for routing\n- POI markers with tap-to-preview\n\n### 3. Map Integration in App\n- Map view in Explore tab (map/list toggle)\n- Map in Route Cards (show route + current position)\n- Map in Place Detail (show location)\n- \"Offline map not downloaded\" graceful degradation\n\n### 4. Progressive Disclosure\n- Cluster markers when zoomed out\n- Show detail markers when zoomed in\n- Performance budget: 60fps on mid-tier devices\n\n## Two-Layer Strategy (from plan.md)\n\n### Online Layer (when connected)\n- MapKit (iOS) / Google Maps (Android) for browsing\n- \"Open in Maps\" for turn-by-turn (handoff to native)\n\n### Offline Layer (when downloaded)\n- Bundled map tiles (MBTiles or vector)\n- On-device rendering\n- Offline routing via bundled walking graph\n\n## Technical Approach\n\n### iOS\n- Option 1: MapLibre Native (open source, vector tiles)\n- Option 2: Custom MBTiles renderer\n- Store tiles in app's Documents/Maps/\n\n### Android\n- Option 1: MapLibre Android (same as iOS for parity)\n- Option 2: osmdroid with MBTiles\n- Store tiles in app's internal storage\n\n### Routing Graph\n- Precomputed walking graph for Medina\n- Simple A* or Dijkstra for route calculation\n- Output: polyline for display, list of waypoints\n\n## Pack Structure\nmedina-map/\n├── tiles/           # Map tiles (MBTiles or directory)\n├── routing.graph    # Walking graph for A* routing\n├── pois.json        # POI markers with categories\n└── manifest.json    # Version, checksum, dependencies\n\n## Graceful Degradation\nIf pack not downloaded:\n- Show \"Offline map available\" banner with download link\n- Fall back to compass-only guidance\n- Still show text directions and distances\n\n## Performance Requirements\n- Map renders at 60fps on mid-tier device\n- Pan/zoom feels native (no jank)\n- Initial load < 500ms\n- Memory usage bounded (tile cache limits)\n\n## Success Criteria\n- User can see their location in Medina without internet\n- User can see route to next stop without internet\n- Place markers display correctly with clustering\n- Performance meets budget on target devices\n\n## Dependencies\n- Downloads System (for pack management)\n- Location Services (for user location dot)\n- GeoEngine (for distance calculations)","status":"open","priority":0,"issue_type":"feature","created_at":"2026-02-07T22:46:37.952942995Z","created_by":"ubuntu","updated_at":"2026-02-07T22:50:49.328677819Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-3rw","depends_on_id":"bd-1av","type":"blocks","created_at":"2026-02-07T22:50:49.328654876Z","created_by":"ubuntu"},{"issue_id":"bd-3rw","depends_on_id":"bd-34f","type":"parent-child","created_at":"2026-02-07T22:46:37.956379809Z","created_by":"ubuntu"},{"issue_id":"bd-3rw","depends_on_id":"bd-z5z","type":"blocks","created_at":"2026-02-07T22:50:49.280953430Z","created_by":"ubuntu"}]}
{"id":"bd-3t1","title":"Backfill missing place image references","description":"Add image references for places missing images in shared/content/places.json (currently 33/49 without image refs), using canonical extraction assets and verifying file existence.","status":"in_progress","priority":2,"issue_type":"task","created_at":"2026-02-07T23:11:01.437101008Z","created_by":"ubuntu","updated_at":"2026-02-08T21:32:34.126176581Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-3t1","depends_on_id":"bd-1s9","type":"parent-child","created_at":"2026-02-07T23:11:16.306377147Z","created_by":"ubuntu"}]}
{"id":"bd-4aw","title":"iOS Foundation — Swift/SwiftUI App Shell","description":"# Feature: iOS Foundation\n\n## Purpose\nSet up the iOS Xcode project with all foundational infrastructure: navigation, database layer, theming, and basic components. This provides the scaffolding for all iOS features.\n\n## Why It Matters\nA well-structured foundation prevents:\n- Architectural chaos as features are added\n- Database access inconsistencies\n- Navigation bugs and state management issues\n- Design inconsistency across screens\n\n## What Gets Built\n\n### 1. Xcode Project Structure\nios/MarrakechGuide/\n├── MarrakechGuide.xcodeproj\n└── MarrakechGuide/\n    ├── App/           # Entry point, lifecycle\n    ├── Core/          # Database, repositories, services, engines\n    ├── Features/      # Feature modules\n    ├── Shared/        # Components, models, extensions\n    └── Resources/     # Assets, localization, seed data\n\n### 2. Database Layer (GRDB.swift)\n- ContentDatabase.swift: Read-only access to content.db\n- UserDatabase.swift: Read-write for user state\n- DatabaseManager.swift: Lifecycle management, DB initialization\n- Proper connection pooling and thread safety\n\n### 3. Navigation\n- Tab-based navigation (5 tabs)\n- NavigationStack for drill-down flows\n- Consistent back navigation with swipe gesture\n\n### 4. Theme System\n- Design tokens (colors, typography, spacing)\n- Marrakech terracotta palette\n- Dark mode support from day one\n- Reusable components using tokens\n\n### 5. Basic Components\n- Card, Chip, PriceTag\n- SectionHeader\n- OfflineBanner\n- Skeleton/placeholder views\n\n## Technical Stack\n- Swift 5.9+ with Swift Concurrency\n- SwiftUI (minimum iOS 16.0)\n- GRDB.swift for SQLite\n- No external UI frameworks (native SwiftUI only)\n\n## Key Decisions Made Here\n- GRDB over Core Data (better FTS5 support, more control)\n- SwiftUI over UIKit (modern, declarative)\n- Two separate database files (clean content swap)\n- Feature-based folder structure (not layer-based)\n\n## Success Criteria\n- App builds and runs on iOS 16+ simulator\n- Tab navigation works\n- Content.db loads successfully from seed location\n- User.db initializes on first run\n- Theme applies consistently\n- Basic components render correctly\n\n## Dependencies\n- Requires: Content pipeline produces content.db\n- Can proceed in parallel with Android foundation","status":"closed","priority":0,"issue_type":"feature","created_at":"2026-02-07T22:26:43.922358270Z","created_by":"ubuntu","updated_at":"2026-02-08T21:36:37.154959763Z","closed_at":"2026-02-08T21:36:37.154778962Z","close_reason":"iOS Foundation complete: App shell, Core (Database, Repositories, Engines, Services), Features structure, XcodeGen project.yml, GRDB integration.","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-4aw","depends_on_id":"bd-3lc","type":"parent-child","created_at":"2026-02-07T22:26:43.925638823Z","created_by":"ubuntu"}]}
{"id":"bd-bh5","title":"Settings & Diagnostics — User Preferences and Debug Info","description":"# Feature: Settings & Diagnostics\n\n## Purpose\nProvide user control over app preferences and diagnostic information for troubleshooting.\n\n## Screens\n\n### SettingsView/Screen\nMain settings hub:\n\n**Account-Free Zone**\n- No login, no accounts, no sync\n- Just local preferences\n\n**Sections:**\n\n#### General\n- Language (English, French)\n- Home Currency (for conversions)\n- Exchange Rate (manual entry with date)\n\n#### Offline & Downloads\n- Link to DownloadsView\n- Wi-Fi Only Downloads toggle\n- Storage Used: X MB\n\n#### Home Base\n- Current: \"Riad Dar Maya\"\n- Change / Remove button\n\n#### Privacy\n- Link to Privacy Center\n- Location permission status\n- \"What data is stored\" link\n\n#### About\n- App version\n- Content version\n- Last content update\n- Link to Diagnostics\n\n#### Support\n- FAQ link (if available)\n- \"Report an Issue\" (opens email)\n- \"Rate the App\" (store link)\n\n### DiagnosticsView/Screen\nFor troubleshooting:\n\n**Content Status**\n- Content version: 2026.02.01\n- Last updated: 2026-02-15\n- Places count: 47\n- Price cards count: 23\n- Phrases count: 150\n\n**Pack Status**\n- Base Pack: ✓ Installed\n- Medina Map: ✓ Installed (v2026.01)\n- Audio Pack: Not installed\n\n**Offline Readiness**\n- Core content: ✓ Ready\n- Search index: ✓ Ready\n- Home Base: ✓ Set\n- \"Test Offline\" button → Airplane mode prompt\n\n**Storage**\n- Total app storage: 180 MB\n- Content DB: 5 MB\n- User data: 0.2 MB\n- Map tiles: 50 MB\n- Audio: 40 MB\n- Cache: 2 MB\n- \"Clear Cache\" button\n\n**Export Debug Report**\n- Generates text file with:\n  - App version, device info\n  - Pack states\n  - Recent error logs (redacted)\n  - No location data, no personal data\n- Share sheet to email/save\n\n### PrivacyCenterView/Screen\nPlain-language privacy explanation:\n\n**What's Stored on Your Device**\n- Your saved places and recent views\n- Your Home Base location\n- App settings and preferences\n- Downloaded content packs\n\n**What Leaves Your Device**\n- Nothing (in v1)\n- Future: opt-in crash reports only\n\n**Location Data**\n- Used only when compass/navigation screens open\n- Never sent anywhere\n- Never stored beyond current session\n\n**No Accounts**\n- No login required\n- No data synced to cloud\n- Your data stays on your device\n\n**No Tracking**\n- No analytics SDKs\n- No advertising identifiers\n- No third-party trackers\n\n## Implementation Notes\n- Settings stored in UserDefaults (iOS) / DataStore (Android)\n- Diagnostics read from DB and file system\n- Export creates temporary file, then shares\n- Privacy Center is static content (localized)","status":"open","priority":1,"issue_type":"feature","created_at":"2026-02-07T22:38:36.341357199Z","created_by":"ubuntu","updated_at":"2026-02-07T22:38:36.344509567Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-bh5","depends_on_id":"bd-1eo","type":"parent-child","created_at":"2026-02-07T22:38:36.344487033Z","created_by":"ubuntu"}]}
{"id":"bd-gpq","title":"Build internal link checker (check-links.ts)","description":"# Task: Internal Link Checker\n\n## What to Build\nCreate shared/scripts/check-links.ts that validates all internal references between content items.\n\n## Why This Matters\nBroken links cause runtime errors or empty UI. Catching them at build time prevents:\n- Itinerary steps pointing to non-existent places\n- Tips referencing deleted price cards\n- Any cross-reference that would fail at runtime\n\n## Links to Validate\n\n### Itinerary Steps\n- steps[].place_id must exist in places.json\n- steps[].activity_id must exist in activities.json (if we have activities)\n\n### Tips\n- related_place_ids[] must all exist in places.json\n- related_price_card_ids[] must all exist in price_cards.json\n\n### Future: Content Links\nAny link_kind references must point to valid targets.\n\n## Output\n- Exit 0 if all links valid\n- Exit 1+ with detailed broken link report\n\n### Error Format\nitineraries.json:\n  id: \"first-day-marrakech\"\n  step[2].place_id: \"non-existent-place\"\n    error: Referenced place does not exist\n\ntips.json:\n  id: \"taxi-scam-tip\"\n  related_price_card_ids[0]: \"taxi-airport-fake\"\n    error: Referenced price_card does not exist\n\n## Technical Notes\n- Load all content JSON files\n- Build lookup maps (Set<string>) for each content type\n- Iterate through all reference fields and check existence\n- Collect all errors before reporting (don't fail on first)\n\n## Integration\n- npm run check-links runs after validate, before build\n- CI fails if any broken links\n- Can be run independently for quick feedback","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T22:26:07.582353115Z","created_by":"ubuntu","updated_at":"2026-02-07T23:11:01.522861433Z","closed_at":"2026-02-07T23:11:01.522815314Z","close_reason":"Completed: added shared/scripts/check-links.ts with itinerary/tips cross-reference validation and structured error output","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-gpq","depends_on_id":"bd-1s9","type":"parent-child","created_at":"2026-02-07T22:26:07.584730174Z","created_by":"ubuntu"},{"issue_id":"bd-gpq","depends_on_id":"bd-2hz","type":"blocks","created_at":"2026-02-07T22:30:29.721088071Z","created_by":"ubuntu"}]}
{"id":"bd-jex","title":"Validate and prepare existing content for development","description":"# Task: Validate and Prepare Existing Content\n\n## What Changed\nContent already exists in shared/content/ from Lonely Planet extraction:\n- places.json (58KB) — Curated places\n- price_cards.json (20KB) — Price information\n- glossary.json (7KB) — Darija phrases\n- itineraries.json (12KB) — Day plans\n- tips.json (18KB) — Safety tips\n- culture.json (7KB) — Etiquette articles\n- activities.json (13KB) — Day trip activities\n- events.json (1.5KB) — Seasonal events\n\n## What to Do Now\n\n### 1. Audit Existing Content\n- Run schema validation against JSON files\n- Check for missing required fields\n- Identify incomplete entries\n- Count content by category\n\n### 2. Verify Data Quality\n- Coordinates are valid (in Marrakech area)\n- Price ranges are reasonable\n- Hours data is structured correctly\n- Cross-references are valid (itinerary steps → places)\n\n### 3. Fill Critical Gaps\nIf validation reveals missing essentials:\n- Ensure all price card categories covered (taxi, hammam, souks, food)\n- Ensure key phrases present (greetings, numbers, bargaining)\n- Ensure at least 1 complete itinerary with valid step references\n\n### 4. Add Missing Fields\nSome records may need:\n- reviewedAt dates\n- hours_verified_at dates\n- images array (may be placeholder paths)\n- context_modifiers for price cards\n\n### 5. Generate Test Subset\nCreate shared/content/test/ with:\n- 5 places for quick testing\n- 3 price cards\n- 10 phrases\nUsed for fast unit test runs.\n\n## Outputs\n- Validation report (what passed, what needs fixing)\n- List of content gaps\n- Test subset files\n- Recommendation for editorial work needed\n\n## Does NOT Include\n- Schema creation (separate task)\n- Build script creation (separate task)\n- Full content rewrite (deferred)\n\n## Success Criteria\n- All existing content passes schema validation\n- No broken cross-references\n- Test subset enables development","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-07T22:26:25.048359494Z","created_by":"ubuntu","updated_at":"2026-02-07T23:00:40.667001606Z","closed_at":"2026-02-07T23:00:40.666967855Z","close_reason":"Completed","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-jex","depends_on_id":"bd-1s9","type":"parent-child","created_at":"2026-02-07T22:26:25.051202421Z","created_by":"ubuntu"}]}
{"id":"bd-mf6","title":"Arrival Mode — First Hours in Marrakech","description":"# Feature: Arrival Mode\n\n## Purpose\nOpinionated guidance for the first hours in Marrakech, when anxiety is highest and tourists need the most help.\n\n## Why This Matters\nFirst impressions define the trip:\n- Airport to hotel is the highest-scam-risk moment\n- Getting a SIM is confusing without guidance\n- ATM failures are common and stressful\n- Medina orientation prevents early bad experiences\n\nArrival Mode says: \"We've got you covered from the moment you land.\"\n\n## Screens\n\n### ArrivalModeView/Screen (Hub)\nEntry point from Home screen quick actions:\n- \"Welcome to Marrakech!\" header\n- Checklist sections (expandable)\n- Progress indicator (X of Y complete)\n- \"I've Arrived at My Riad\" completion button\n\n### Sections (Expandable Cards)\n\n#### 1. Airport Taxi\n- Expected fare to Medina: 150-200 MAD (fixed, don't negotiate)\n- How to find official taxi stand\n- Red flags: \"special price\" offers, guides at arrival\n- Polite refusal scripts\n- Quick link to Taxi price card\n\n#### 2. SIM / eSIM\n- Recommended: eSIM before arrival (Airalo, etc.)\n- At airport: Maroc Telecom, Orange, Inwi booths\n- What to ask for: 20-50GB data, 7-14 days\n- Typical cost: 100-200 MAD\n- \"Don't need calls, just data\" phrase\n\n#### 3. Cash / ATM\n- ATMs at airport work, but have limits\n- Recommended: Withdraw 1000-2000 MAD to start\n- If ATM fails: try different card, try CIH or Attijariwafa banks\n- Keep small bills (20, 50 MAD) for tipping/small purchases\n- Exchange rate: 1 USD ≈ 10 MAD (rough)\n\n#### 4. Hotel/Riad Transfer\n- Confirm pickup if arranged\n- If taxi: show driver the address (Arabic)\n- Set Home Base now (prompt to set)\n- First tip: 20-50 MAD for help with bags\n\n#### 5. Medina Orientation\n- \"Helpful strangers\" usually want money—polite \"La shukran\"\n- You will get lost. It's OK. Ask shopkeepers for landmarks.\n- Jemaa el-Fna is the center—always ask \"Jemaa el-Fna?\"\n- Link to Home Base setup\n\n### Completion\nWhen user taps \"I've Arrived\":\n- Celebrate briefly\n- Suggest: \"Set up My Day for tomorrow?\"\n- Mark arrival mode as complete (don't show again unless reset)\n\n## Data Model\nChecklists stored in content.db as tips with category = \"arrival\"\n\nCompletion state stored in user.db:\n{\n  \"arrivalComplete\": true,\n  \"arrivalCompletedAt\": \"2026-02-15T14:00:00\"\n}\n\n## Offline Guarantee\n100% offline. Critical at airport where connectivity is spotty.\n\n## Integration\n- Quick action on Home screen: \"Arrival Mode\"\n- Shown prominently on first launch\n- Can re-access from More → Tips → Arrival","status":"open","priority":1,"issue_type":"feature","created_at":"2026-02-07T22:47:25.690994897Z","created_by":"ubuntu","updated_at":"2026-02-07T22:50:49.417239791Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-mf6","depends_on_id":"bd-34f","type":"parent-child","created_at":"2026-02-07T22:47:25.693507308Z","created_by":"ubuntu"},{"issue_id":"bd-mf6","depends_on_id":"bd-3j8","type":"blocks","created_at":"2026-02-07T22:50:49.417219261Z","created_by":"ubuntu"}]}
{"id":"bd-ofw","title":"Phase 4: Backend (Optional) — Convex for Content Updates","description":"# Epic: Backend with Convex\n\n## Purpose\nAdd optional backend capabilities for content updates without app releases, user feedback collection, and potential cross-device sync. This is explicitly optional — the app must remain fully functional without it.\n\n## Why This is Phase 4\nThe app's core value is offline-first. A backend is additive, never required. We defer this to:\n1. Prove the offline experience works first\n2. Avoid premature complexity\n3. Ship faster to start earning revenue\n4. Build based on real user feedback needs\n\n## What Gets Built (If We Proceed)\n\n### 1. Convex Schema\nTables for:\n- places, priceCards, glossaryPhrases, cultureArticles, itineraries, tips\n- contentVersions (version tracking with release notes, rollout percentage)\n- feedback (user-submitted corrections, no account required)\n- Optional: events (curated weekly list with auto-expiration)\n\n### 2. Content Sync\n- Manifest-based versioning with signed bundles\n- Client checks contentVersions.latest\n- Downloads new bundle if newer version available\n- Verifies signature (Ed25519) and sha256\n- Atomic DB swap with rollback on failure\n- Rebuild FTS tables after swap\n\n### 3. Feedback System\nLow-friction \"Was this accurate?\" flow:\n- Stored locally in feedback outbox\n- Uploaded when online (no account required)\n- Quick reasons: closed/moved/hours wrong/price wrong/tourist-trap/other\n- Helps maintain content quality\n\n### 4. Optional Events Feed\nCurated \"What's on this week\":\n- Small JSON feed with expiresAt timestamps\n- Cached for brief offline use\n- Hidden gracefully if unavailable\n- Never blocks core functionality\n\n## Security Considerations\n- Signed manifest (Ed25519) with pinned public key\n- Replay protection (reject manifests older than last accepted)\n- Verify signature before download, sha256 after download\n- Never trust unverified content\n\n## Implementation by Platform\n\n### iOS\n- ContentSyncService using URLSession\n- Background download support\n- Signature verification with CryptoKit\n- Atomic swap with FileManager.replaceItemAt\n\n### Android\n- ContentSyncService using OkHttp + WorkManager\n- Signature verification with java.security\n- Atomic swap with File.renameTo()\n\n## What NOT to Build\n- User accounts (keep anonymous/offline-first)\n- Cloud favorites sync (defer to later version)\n- Real-time features (push notifications, live chat)\n- Analytics SDK (privacy-first)\n\n## Success Criteria\n- Content updates deploy without app release\n- Users see \"What's new\" after update\n- Feedback submissions reach backend\n- Security: no unsigned content accepted\n- Offline experience unchanged (backend unavailable = still works)\n\n## Dependencies\n- Requires: Phase 0-3 complete (backend is frosting, not cake)\n- Blocks: Nothing (this is optional enhancement)\n\n## Decision Point\nEvaluate at end of Phase 3 whether to proceed:\n- Is content changing frequently enough to need updates?\n- Do we have bandwidth to maintain backend?\n- Is user feedback actually needed for content quality?\n\nIf answers are no, skip this phase and ship more content instead.","status":"open","priority":2,"issue_type":"epic","created_at":"2026-02-07T22:24:39.006020965Z","created_by":"ubuntu","updated_at":"2026-02-07T22:39:27.217130787Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-ofw","depends_on_id":"bd-1eo","type":"blocks","created_at":"2026-02-07T22:39:27.217106821Z","created_by":"ubuntu"}]}
{"id":"bd-smj","title":"Implement user state repositories (Favorites, Recents, Settings)","description":"# Task: User State Repositories\n\n## What to Build\nRepositories for managing user data in user.db.\n\n## FavoritesRepository\nprotocol FavoritesRepository {\n    func getFavorites() async throws -> [FavoriteItem]\n    func getFavorites(type: ContentType) async throws -> [FavoriteItem]\n    func isFavorite(contentType: ContentType, contentId: String) async throws -> Bool\n    func addFavorite(contentType: ContentType, contentId: String) async throws\n    func removeFavorite(contentType: ContentType, contentId: String) async throws\n    func toggleFavorite(contentType: ContentType, contentId: String) async throws -> Bool\n}\n\nStores: content_type (place, price_card, phrase, itinerary), content_id, created_at\n\n## RecentsRepository\nprotocol RecentsRepository {\n    func getRecents(limit: Int) async throws -> [RecentItem]\n    func getRecents(type: ContentType, limit: Int) async throws -> [RecentItem]\n    func addRecent(contentType: ContentType, contentId: String) async throws\n    func clearRecents() async throws\n}\n\nStores: content_type, content_id, viewed_at\nAuto-limits to last 50 items (prune old entries)\n\n## UserSettingsRepository\nprotocol UserSettingsRepository {\n    func getSetting<T: Codable>(key: SettingKey) async throws -> T?\n    func setSetting<T: Codable>(key: SettingKey, value: T) async throws\n    func getHomeBase() async throws -> HomeBase?\n    func setHomeBase(_ homeBase: HomeBase) async throws\n    func getExchangeRate() async throws -> ExchangeRate?\n    func setExchangeRate(_ rate: ExchangeRate) async throws\n}\n\nKeys: homeBase, exchangeRate, wifiOnlyDownloads, language, lastContentVersion\nValues: JSON-encoded in TEXT column\n\n## Data Privacy\n- All user data stays on device\n- No sync to backend in v1\n- Data persists across app updates\n- User can clear data via settings\n\n## Platform Parity\n- Same interface on iOS and Android\n- Same data structure\n- Favorites/recents work identically","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T22:31:43.857022812Z","created_by":"ubuntu","updated_at":"2026-02-07T23:34:06.588104979Z","closed_at":"2026-02-07T23:34:06.588012731Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-smj","depends_on_id":"bd-3j8","type":"parent-child","created_at":"2026-02-07T22:31:43.860241461Z","created_by":"ubuntu"}]}
{"id":"bd-ufm","title":"Implement tab navigation structure (5 tabs)","description":"# Task: iOS Tab Navigation\n\n## What to Build\nSwiftUI TabView with 5 tabs matching the product design.\n\n## Tabs\n1. Home (house.fill) — Quick actions, today's tip, saved items\n2. Explore (binoculars.fill) — Browse places, landmarks, neighborhoods\n3. Eat (fork.knife) — Restaurants and cafes\n4. Prices (tag.fill) — Price cards and Quote → Action\n5. More (ellipsis) — Darija, Itineraries, Tips, Culture, Settings\n\n## Implementation\n\n### ContentView.swift\nstruct ContentView: View {\n    @State private var selectedTab: Tab = .home\n    \n    var body: some View {\n        TabView(selection: $selectedTab) {\n            HomeView()\n                .tabItem { Label(\"Home\", systemImage: \"house.fill\") }\n                .tag(Tab.home)\n            \n            ExploreView()\n                .tabItem { Label(\"Explore\", systemImage: \"binoculars.fill\") }\n                .tag(Tab.explore)\n            \n            EatView()\n                .tabItem { Label(\"Eat\", systemImage: \"fork.knife\") }\n                .tag(Tab.eat)\n            \n            PricesView()\n                .tabItem { Label(\"Prices\", systemImage: \"tag.fill\") }\n                .tag(Tab.prices)\n            \n            MoreView()\n                .tabItem { Label(\"More\", systemImage: \"ellipsis\") }\n                .tag(Tab.more)\n        }\n    }\n}\n\nenum Tab: Hashable {\n    case home, explore, eat, prices, more\n}\n\n### Placeholder Views\nEach feature view should exist as a placeholder:\nstruct HomeView: View {\n    var body: some View {\n        NavigationStack {\n            Text(\"Home\")\n                .navigationTitle(\"Home\")\n        }\n    }\n}\n\n### Navigation Stacks\nEach tab wraps its content in NavigationStack for drill-down:\n- Explore → PlaceDetail\n- Eat → PlaceDetail\n- Prices → PriceCardDetail\n- More → various sub-screens\n\n## Platform-Native Rules\n- Never customize tab bar appearance beyond theming\n- Preserve standard touch targets\n- Keep 5 tabs maximum (Apple HIG)\n- Tab switching should be instant\n\n## State Preservation\n- Tab selection should persist across app restarts (UserDefaults)\n- Navigation stacks reset on tab switch (standard iOS behavior)\n\n## Verification\n- All 5 tabs appear correctly\n- Tab icons and labels display\n- Tapping tabs switches content\n- NavigationStack works for drill-down","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T22:27:28.859926469Z","created_by":"ubuntu","updated_at":"2026-02-07T23:06:27.848936332Z","closed_at":"2026-02-07T23:06:27.848871836Z","close_reason":"Implemented 5-tab SwiftUI navigation shell in ContentView with placeholder NavigationStack views and persisted tab selection.","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-ufm","depends_on_id":"bd-4aw","type":"parent-child","created_at":"2026-02-07T22:27:28.862735646Z","created_by":"ubuntu"}]}
{"id":"bd-vk1","title":"Build content validation script (validate-content.ts)","description":"# Task: Content Validation Script\n\n## What to Build\nCreate shared/scripts/validate-content.ts that validates all JSON content against the schema.\n\n## Functionality\n\n### Input\n- Read all JSON files from shared/content/:\n  - places.json, price_cards.json, glossary.json\n  - itineraries.json, tips.json, culture.json\n\n### Validation Rules\n1. Schema validation against content-schema.json\n2. Unique ID enforcement (no duplicate IDs within a content type)\n3. Coordinate validation (lat/lng within valid ranges)\n4. Price consistency (minMad <= maxMad everywhere)\n5. Required date fields present (updatedAt, reviewedAt where required)\n6. Non-empty arrays where content expected\n\n### Output\n- Exit 0 if all validations pass\n- Exit 1+ with detailed error messages if failures\n- Errors should include: file, item ID, field name, what's wrong\n\n### Error Format\nfile: places.json\n  id: \"jemaa-el-fna\"\n    field: lat\n    error: Value 91.0 exceeds maximum 90.0\n\n## Technical Notes\n- Use ajv for JSON Schema validation (fast, comprehensive)\n- TypeScript with strict mode\n- Node.js compatible (runs in CI)\n- No external network calls\n\n## Integration\n- npm run validate should run this script\n- CI runs on every PR\n- Blocks build-bundle.ts if failures\n\n## Dependencies\n- Requires: JSON Schema (bd-w12) to exist\n- Content JSON files must exist (even if minimal)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T22:25:35.134696395Z","created_by":"ubuntu","updated_at":"2026-02-07T23:08:17.300675887Z","closed_at":"2026-02-07T23:08:17.300632752Z","close_reason":"Created validate-content.ts with ajv JSON Schema validation (draft-2020-12), unique ID checks, coordinate validation, price range validation, duration checks, context modifier validation, and fairness multiplier validation. All 163 items across 8 content files pass validation.","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-vk1","depends_on_id":"bd-1s9","type":"parent-child","created_at":"2026-02-07T22:25:35.141367326Z","created_by":"ubuntu"},{"issue_id":"bd-vk1","depends_on_id":"bd-w12","type":"blocks","created_at":"2026-02-07T22:30:29.648689530Z","created_by":"ubuntu"}]}
{"id":"bd-vzh","title":"Build reusable Compose components (Card, Chip, PriceTag, etc.)","description":"# Task: Android Reusable Components\n\n## What to Build\nShared Compose components matching iOS counterparts.\n\n## Components to Create\n\n### Card.kt\n@Composable\nfun ContentCard(\n    modifier: Modifier = Modifier,\n    title: String? = null,\n    onClick: (() -> Unit)? = null,\n    content: @Composable ColumnScope.() -> Unit\n) {\n    Card(\n        modifier = modifier,\n        onClick = onClick ?: {},\n        colors = CardDefaults.cardColors(...)\n    ) {\n        Column(modifier = Modifier.padding(16.dp)) {\n            title?.let { \n                Text(it, style = MaterialTheme.typography.titleMedium)\n                Spacer(modifier = Modifier.height(8.dp))\n            }\n            content()\n        }\n    }\n}\n\n### Chip.kt\n@Composable\nfun CategoryChip(\n    text: String,\n    selected: Boolean = false,\n    onClick: () -> Unit = {}\n) {\n    FilterChip(\n        selected = selected,\n        onClick = onClick,\n        label = { Text(text) }\n    )\n}\n\n### PriceTag.kt\n@Composable\nfun PriceTag(\n    minMad: Int?,\n    maxMad: Int?,\n    modifier: Modifier = Modifier\n) {\n    Text(\n        text = formatPriceRange(minMad, maxMad),\n        style = MaterialTheme.typography.labelLarge,\n        color = MaterialTheme.colorScheme.primary,\n        modifier = modifier\n    )\n}\n\n### SectionHeader.kt\n@Composable\nfun SectionHeader(\n    title: String,\n    actionText: String? = null,\n    onAction: (() -> Unit)? = null\n) {\n    Row(\n        modifier = Modifier.fillMaxWidth().padding(16.dp),\n        horizontalArrangement = Arrangement.SpaceBetween,\n        verticalAlignment = Alignment.CenterVertically\n    ) {\n        Text(title, style = MaterialTheme.typography.titleMedium)\n        actionText?.let {\n            TextButton(onClick = onAction ?: {}) {\n                Text(it)\n            }\n        }\n    }\n}\n\n### OfflineBanner.kt\n@Composable\nfun OfflineBanner(\n    onDismiss: () -> Unit\n) {\n    Surface(\n        color = MaterialTheme.colorScheme.surfaceVariant\n    ) {\n        Row(\n            modifier = Modifier.fillMaxWidth().padding(8.dp),\n            verticalAlignment = Alignment.CenterVertically\n        ) {\n            Icon(Icons.Filled.CloudOff, \"Offline\")\n            Spacer(Modifier.width(8.dp))\n            Text(\"Offline • Core guide still works\")\n            Spacer(Modifier.weight(1f))\n            IconButton(onClick = onDismiss) {\n                Icon(Icons.Filled.Close, \"Dismiss\")\n            }\n        }\n    }\n}\n\n### SkeletonLoader.kt\n@Composable\nfun SkeletonLoader(\n    modifier: Modifier = Modifier\n) {\n    // Shimmer effect placeholder\n    Box(\n        modifier = modifier\n            .background(\n                brush = shimmerBrush(),\n                shape = MaterialTheme.shapes.medium\n            )\n    )\n}\n\n### ErrorState.kt\n@Composable\nfun ErrorState(\n    message: String,\n    onRetry: () -> Unit\n) {\n    Column(\n        modifier = Modifier.fillMaxSize(),\n        horizontalAlignment = Alignment.CenterHorizontally,\n        verticalArrangement = Arrangement.Center\n    ) {\n        Icon(Icons.Filled.Error, \"Error\", tint = MaterialTheme.colorScheme.error)\n        Spacer(Modifier.height(16.dp))\n        Text(message)\n        Spacer(Modifier.height(16.dp))\n        Button(onClick = onRetry) { Text(\"Retry\") }\n    }\n}\n\n## Design Principles\n- All components use MaterialTheme tokens\n- Touch targets ≥48dp\n- Proper content descriptions for TalkBack\n- Support RTL layout\n- Match iOS counterpart behavior\n\n## Verification\n- Components render in previews\n- Theme colors apply correctly\n- Accessibility labels work\n- Components compose correctly","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-07T22:30:20.458254844Z","created_by":"ubuntu","updated_at":"2026-02-08T21:36:40.386647518Z","closed_at":"2026-02-08T21:36:40.386600627Z","close_reason":"Completed reusable Compose components in ScreenStateComponents with compile/lint verification","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-vzh","depends_on_id":"bd-26j","type":"parent-child","created_at":"2026-02-07T22:30:20.461615255Z","created_by":"ubuntu"}]}
{"id":"bd-w12","title":"Define JSON Schema for all content types","description":"# Task: Define JSON Schema\n\n## What to Build\nCreate shared/schema/content-schema.json with complete JSON Schema definitions for all content types.\n\n## Content Types to Define\n\n### places\nRequired fields: id, name, category, shortDescription\nOptional fields: aliases[], regionId, longDescription, reviewedAt, status, confidence, touristTrapLevel, neighborhood, address, lat, lng, hoursText, hoursWeekly[], hoursVerifiedAt, feesMinMad, feesMaxMad, expectedCostMinMad, expectedCostMaxMad, visitMinMinutes, visitMaxMinutes, bestTimeToGo, tags[], localTips[], scamWarnings[], images[]\n\n### price_cards\nRequired fields: id, title, category, expectedCostMinMad, expectedCostMaxMad, expectedCostUpdatedAt\nOptional fields: unit, volatility, confidence, whatInfluencesPrice[], negotiationScripts[], redFlags[], contextModifiers[], fairnessHighMultiplier\n\n### glossary (phrases)\nRequired fields: id, category, arabic, latin, english\nOptional fields: audio\n\n### itineraries\nRequired fields: id, title, duration, steps[]\nSteps must reference valid placeId or activityId\n\n### tips\nRequired fields: id, title, content, category\nOptional fields: relatedPlaceIds[], relatedPriceCardIds[]\n\n### culture\nRequired fields: id, title, content\nOptional fields: category, doAndDont[]\n\n## Schema Features to Include\n- Strict type checking (string, number, array, etc.)\n- Required vs optional field distinction\n- Enum values where appropriate (category, status, confidence)\n- Coordinate validation (lat -90 to 90, lng -180 to 180)\n- Price validation (min <= max)\n- Date format validation (ISO 8601)\n- Array item schemas\n\n## Output\nshared/schema/content-schema.json — valid JSON Schema (draft-07 or later)\n\n## Validation\nSchema itself should be valid JSON Schema (use online validator to check)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T22:25:21.586353083Z","created_by":"ubuntu","updated_at":"2026-02-07T23:04:08.935874695Z","closed_at":"2026-02-07T23:04:08.935821205Z","close_reason":"Completed: added shared/schema/content-schema.json and verified against all shared/content bundles","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-w12","depends_on_id":"bd-1s9","type":"parent-child","created_at":"2026-02-07T22:25:21.589469461Z","created_by":"ubuntu"}]}
{"id":"bd-wnm","title":"Implement GRDB database layer (ContentDatabase + UserDatabase)","description":"# Task: iOS Database Layer with GRDB\n\n## What to Build\nDatabase access layer using GRDB.swift for both content and user databases.\n\n## Two-Database Architecture\n\n### ContentDatabase.swift\n- Opens content.db from SeedData/ on first run\n- Copies to Documents/ for potential future updates\n- Read-only access (never write to content)\n- Provides DatabasePool for concurrent reads\n\n### UserDatabase.swift\n- Creates user.db in Documents/ on first run\n- Read-write access\n- Stores: favorites, recents, settings, plans, route progress\n- Migrations for schema changes\n\n### DatabaseManager.swift\n- Singleton or injected service\n- Initializes both databases on app launch\n- Handles first-run setup (copy seed content.db)\n- Provides access to both database pools\n- Handles content.db swap for updates (Phase 2)\n\n## Database Schemas\n\n### user.db tables\n\nuser_settings:\nCREATE TABLE user_settings (\n    key TEXT PRIMARY KEY,\n    value TEXT  -- JSON encoded\n);\n\nfavorites:\nCREATE TABLE favorites (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    content_type TEXT NOT NULL,\n    content_id TEXT NOT NULL,\n    created_at TEXT NOT NULL\n);\n\nrecents:\nCREATE TABLE recents (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    content_type TEXT NOT NULL,\n    content_id TEXT NOT NULL,\n    viewed_at TEXT NOT NULL\n);\n\n## GRDB Usage Patterns\n\n### Model conformance\nstruct Place: Codable, FetchableRecord, PersistableRecord {\n    let id: String\n    let name: String\n    // ... other fields\n    \n    static let databaseTableName = \"places\"\n}\n\n### Querying\nlet places = try contentDB.read { db in\n    try Place.fetchAll(db)\n}\n\n### FTS5 queries\nlet results = try contentDB.read { db in\n    try Place.fetchAll(db, sql: \"\"\"\n        SELECT places.* FROM places\n        JOIN places_fts ON places.rowid = places_fts.rowid\n        WHERE places_fts MATCH ?\n    \"\"\", arguments: [query])\n}\n\n## Thread Safety\n- DatabasePool for concurrent reads\n- All DB access via async methods\n- Never block main thread on DB operations\n\n## Error Handling\n- Catch and log database errors\n- Fallback gracefully (show error state, not crash)\n- Report errors for diagnostics\n\n## Verification\n- Content.db loads without errors\n- User.db creates on first run\n- Basic queries return expected results\n- FTS search works on content","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T22:27:13.533993377Z","created_by":"ubuntu","updated_at":"2026-02-07T23:22:08.366180305Z","closed_at":"2026-02-07T23:22:08.366088107Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-wnm","depends_on_id":"bd-2hz","type":"blocks","created_at":"2026-02-07T22:30:29.771355987Z","created_by":"ubuntu"},{"issue_id":"bd-wnm","depends_on_id":"bd-4aw","type":"parent-child","created_at":"2026-02-07T22:27:13.536756946Z","created_by":"ubuntu"}]}
{"id":"bd-xdg","title":"Implement PriceCardRepository (iOS + Android)","description":"# Task: PriceCardRepository\n\n## What to Build\nRepository for accessing price card data, critical for Quote → Action.\n\n## Interface\n\nprotocol PriceCardRepository {\n    func getAllPriceCards() async throws -> [PriceCard]\n    func getPriceCard(id: String) async throws -> PriceCard?\n    func getPriceCards(category: String) async throws -> [PriceCard]\n    func searchPriceCards(query: String) async throws -> [PriceCard]\n    func getModifiersFor(cardId: String) async throws -> [ContextModifier]\n    func getScriptsFor(cardId: String) async throws -> [NegotiationScript]\n}\n\n## Key Fields\n- expectedCostMinMad, expectedCostMaxMad\n- contextModifiers (JSON array of modifier objects)\n- negotiationScripts (JSON array of script objects)\n- fairnessHighMultiplier\n- unit (per ride, per person, etc.)\n- volatility, confidence\n\n## Modifier Structure\ncontextModifiers JSON array contains:\n{\n  \"id\": \"night\",\n  \"label\": \"Night (after 8pm)\",\n  \"factorMin\": 1.2,\n  \"factorMax\": 1.3,\n  \"notes\": \"Higher fares after dark\"\n}\n\n## Script Structure\nnegotiationScripts JSON array contains:\n{\n  \"darijaLatin\": \"Bzef! Mashi mzyan.\",\n  \"arabic\": \"بزاف! ماشي مزيان\",\n  \"english\": \"Too much! Not good.\",\n  \"french\": \"C'est trop! Pas bon.\"\n}\n\n## Queries\n- Get by category (taxi, hammam, souks, food)\n- Search by title\n- Get single card with all details parsed\n\n## Platform Parity\nBoth platforms must parse modifiers and scripts identically.\nPricingEngine depends on this data structure.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T22:31:17.958330582Z","created_by":"ubuntu","updated_at":"2026-02-07T23:30:12.299389114Z","closed_at":"2026-02-07T23:30:12.299267021Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-xdg","depends_on_id":"bd-3j8","type":"parent-child","created_at":"2026-02-07T22:31:17.960804907Z","created_by":"ubuntu"}]}
{"id":"bd-y38","title":"Implement bottom navigation with Navigation Compose","description":"# Task: Android Bottom Navigation\n\n## What to Build\nMaterial 3 bottom navigation with 5 destinations matching iOS.\n\n## Navigation Destinations\n1. Home (Icons.Filled.Home)\n2. Explore (Icons.Filled.Explore)\n3. Eat (Icons.Filled.Restaurant)\n4. Prices (Icons.Filled.LocalOffer)\n5. More (Icons.Filled.MoreHoriz)\n\n## Implementation\n\n### NavGraph.kt\nsealed class Screen(val route: String) {\n    object Home : Screen(\"home\")\n    object Explore : Screen(\"explore\")\n    object Eat : Screen(\"eat\")\n    object Prices : Screen(\"prices\")\n    object More : Screen(\"more\")\n    \n    // Detail screens\n    object PlaceDetail : Screen(\"place/{placeId}\")\n    object PriceCardDetail : Screen(\"priceCard/{cardId}\")\n}\n\n### BottomNavBar.kt\n@Composable\nfun BottomNavBar(\n    navController: NavController,\n    currentRoute: String?\n) {\n    NavigationBar {\n        bottomNavItems.forEach { item ->\n            NavigationBarItem(\n                icon = { Icon(item.icon, contentDescription = item.label) },\n                label = { Text(item.label) },\n                selected = currentRoute == item.route,\n                onClick = {\n                    navController.navigate(item.route) {\n                        popUpTo(navController.graph.startDestinationId)\n                        launchSingleTop = true\n                    }\n                }\n            )\n        }\n    }\n}\n\n### MainActivity.kt\n@AndroidEntryPoint\nclass MainActivity : ComponentActivity() {\n    override fun onCreate(savedInstanceState: Bundle?) {\n        super.onCreate(savedInstanceState)\n        enableEdgeToEdge()\n        setContent {\n            MarrakechGuideTheme {\n                MainScreen()\n            }\n        }\n    }\n}\n\n@Composable\nfun MainScreen() {\n    val navController = rememberNavController()\n    val currentRoute = navController.currentBackStackEntryAsState().value?.destination?.route\n    \n    Scaffold(\n        bottomBar = {\n            BottomNavBar(navController, currentRoute)\n        }\n    ) { padding ->\n        NavHost(\n            navController = navController,\n            startDestination = Screen.Home.route,\n            modifier = Modifier.padding(padding)\n        ) {\n            composable(Screen.Home.route) { HomeScreen() }\n            composable(Screen.Explore.route) { ExploreScreen() }\n            composable(Screen.Eat.route) { EatScreen() }\n            composable(Screen.Prices.route) { PricesScreen() }\n            composable(Screen.More.route) { MoreScreen() }\n            \n            // Detail screens\n            composable(Screen.PlaceDetail.route) { backStackEntry ->\n                PlaceDetailScreen(backStackEntry.arguments?.getString(\"placeId\"))\n            }\n        }\n    }\n}\n\n## Predictive Back\nEnable predictive back animation:\n- AndroidManifest: android:enableOnBackInvokedCallback=\"true\"\n- Handle back in NavHost correctly\n\n## Platform Rules\n- Use Material 3 NavigationBar component\n- Keep 5 items maximum\n- Proper icons and labels\n- Touch targets ≥48dp\n\n## Verification\n- All 5 destinations reachable\n- Bottom bar highlights current tab\n- Navigation state preserved on config change\n- Back button works correctly\n- Predictive back animation works","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-07T22:29:41.915768580Z","created_by":"ubuntu","updated_at":"2026-02-07T23:14:28.021952334Z","closed_at":"2026-02-07T23:14:28.021896201Z","close_reason":"Implemented 5-tab Navigation Compose scaffold with NavHost, bottom bar, tab routes, detail routes, predictive back manifest flag, and placeholder destination screens. compileDebugKotlin remains blocked here by missing Android SDK configuration.","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-y38","depends_on_id":"bd-26j","type":"parent-child","created_at":"2026-02-07T22:29:41.918774060Z","created_by":"ubuntu"}]}
{"id":"bd-z5z","title":"Downloads System — Reliable Pack Management","description":"# Feature: Downloads System\n\n## Purpose\nManage optional content packs (maps, audio, high-res images) with reliable, resumable downloads.\n\n## Why This Matters\n- Users need offline maps for Medina navigation\n- Audio phrases are valuable but large\n- Downloads must be reliable (tourists on spotty hotel WiFi)\n- Bad download UX = 1-star reviews\n\n## Pack Types\n\n### Base Pack (Ships with App)\n- Core content.db\n- All text content\n- Essential images\n- Bundled, never downloaded\n\n### Medina Map Pack\n- Offline map tiles for Medina\n- Walking graph for routing\n- ~50MB\n- Enables offline navigation\n\n### Gueliz Pack\n- Offline map tiles for new city\n- POIs for Gueliz area\n- ~30MB\n\n### Audio Pack\n- Spoken Darija phrases\n- Mini audio guides\n- ~40MB\n\n### Images Pack (Optional)\n- High-resolution photos\n- ~100MB\n- Premium visual experience\n\n## Screens\n\n### DownloadsView/Screen\nList of available packs:\n- Pack name + description\n- Size (MB)\n- Status indicator:\n  - ⬇️ Available to download\n  - ⏳ Queued\n  - 📥 Downloading (45%)\n  - ✓ Installed\n  - ⚠️ Update available\n- Actions: Download / Pause / Resume / Remove\n- \"Update All\" button (if updates available)\n\n### Pack Detail (Bottom Sheet)\n- Full description\n- What's included\n- Disk space required\n- \"Free space\" check\n- Download / Remove buttons\n\n### Download Progress\n- Determinate progress bar (percentage)\n- Bytes downloaded / total\n- Download speed\n- Pause / Cancel buttons\n- State: Downloading → Verifying → Installing → Complete\n\n## DownloadService\n\n### iOS Implementation\n- URLSession with downloadTask\n- Background session for reliability\n- Resume data stored for pause/resume\n- Disk space check via FileManager\n\n### Android Implementation\n- OkHttp with Range header support\n- WorkManager for background reliability\n- Resume data persistence\n- StatFs for disk space check\n\n### Common Logic\n- Check disk space before starting\n- Verify sha256 after download\n- Atomic install (temp → verify → move)\n- Rollback on failure\n- State persistence across app restarts\n\n## Pack Manifest\nEach pack has manifest with:\n{\n  \"id\": \"medina-map\",\n  \"version\": \"2026.02.01\",\n  \"displayName\": \"Medina Offline Map\",\n  \"description\": \"Offline map tiles and routing for the old city\",\n  \"sizeBytes\": 52428800,\n  \"sha256\": \"abc123...\",\n  \"downloadUrl\": \"https://...\",\n  \"dependencies\": [],\n  \"minAppVersion\": \"1.0.0\"\n}\n\n## Error Handling\n- Network error: Retry with exponential backoff\n- Disk full: Clear error, suggest cleanup\n- Verification failed: Re-download\n- Install failed: Rollback, show error\n- All errors: Clear message + action\n\n## Wi-Fi Settings\n- \"Download on Wi-Fi only\" toggle\n- If cellular and large pack: confirmation dialog\n- Respects system data saver mode\n\n## Backup Exclusion\n- Downloaded packs excluded from iCloud/Auto Backup\n- Only user.db and preferences backed up\n- Keeps backup small, restore fast","status":"open","priority":0,"issue_type":"feature","created_at":"2026-02-07T22:37:30.420006684Z","created_by":"ubuntu","updated_at":"2026-02-07T22:37:30.423534975Z","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"bd-z5z","depends_on_id":"bd-1eo","type":"parent-child","created_at":"2026-02-07T22:37:30.423505882Z","created_by":"ubuntu"}]}
